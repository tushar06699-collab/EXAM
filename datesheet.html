<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Datesheet Add - School ERP</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
/* ... same CSS as before ... */
body {margin:0;font-family:Poppins,sans-serif;background:#f2f4f7;display:flex;}
.sidebar {width:240px;background:#233465;color:white;height:100vh;position:fixed;left:0;top:0;padding:20px;transition: transform 0.3s ease;}
.sidebar.closed {transform: translateX(-240px);}
.sidebar h2{text-align:center;margin-bottom:20px;}
.sidebar a{color:white;text-decoration:none;display:block;padding:10px 15px;}
.sidebar a.active{background:rgba(255,255,255,0.2);}
.content {margin-left:240px;padding:20px;width:calc(100% - 240px);transition: margin-left 0.3s ease;}
.content.full {margin-left:0;width:100%;}
header {background:#233465;padding:15px;color:white;text-align:center;font-size:20px;border-radius:8px;position:relative;}
.hamburger {position:absolute;left:15px;top:50%;transform:translateY(-50%);cursor:pointer;width:30px;height:20px;display:flex;flex-direction:column;justify-content:space-between;}
.hamburger div {height:4px;background:white;border-radius:2px;}
table {width:100%;border-collapse:collapse;margin-top:20px;}
th, td {border:1px solid #ccc;padding:10px;text-align:center;}
th {background:#e8e8e8;}
input[type="date"] {padding:6px;width:120px;}
button {margin-top:20px;padding:12px;width:100%;background:#4f46e5;color:white;border:none;border-radius:6px;cursor:pointer;}
.btn-pdf{background:#0f766e;}
</style>
</head>
<body>

<div class="sidebar" id="sidebar">
  <h2>School ERP</h2>
  <a href="dashboard.html">Dashboard</a>
  <a href="exam_create.html">Exam Create</a>
  <a href="datesheet.html" style="background: rgba(255,255,255,0.2);">Make Datesheet</a>
  <a href="datesheet_full.html">See Datesheet</a>
</div>

<div class="content" id="content">
<header>
  <div class="hamburger" id="hamburger">
    <div></div>
    <div></div>
    <div></div>
  </div>
  Datesheet (All Classes at Once)
</header>

<div class="controls">
  <div class="form-group">
    <label for="sessionSelect">......Session</label>
    <select id="sessionSelect" disabled></select>
  </div>

  <div class="form-group">
    <label for="examSelect">Select Exam</label>
    <select id="examSelect"></select>
  </div>
</div>

<style>
/* Controls layout */
.controls {
  display: flex;
  align-items: center;
  gap: 20px; /* space between Session and Exam */
  margin: 15px 0;
}

.form-group {
  display: flex;
  align-items: center;
  gap: 5px; /* space between label and select */
}

.form-group label {
  min-width: 70px; /* ensures "Session" fits fully */
  font-weight: 500;
}

.form-group select {
  padding: 5px 8px;
  font-size: 14px;
}
</style>

<table id="sheetTable">
  <thead id="thead"></thead>
  <tbody id="tbody"></tbody>
</table>

<button onclick="saveAll()">SAVE FULL DATESHEET</button>
<button class="btn-pdf" onclick="downloadPDF()">DOWNLOAD PDF</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
const FEE_API = "https://fee-backend-ntas.onrender.com";
const EXAM_API = "https://exam-backend-117372286918.asia-south1.run.app/";
const STUDENT_API = "https://student-backend-117372286918.asia-south1.run.app/";

const sessionSelect = document.getElementById("sessionSelect");
const examSelect = document.getElementById("examSelect");
const thead = document.getElementById("thead");
const tbody = document.getElementById("tbody");

let CLASS_LIST = [];
let EXAMS = [];
let SUBJECTS_BY_CLASS = {};

// Sidebar toggle
const sidebar = document.getElementById("sidebar");
const content = document.getElementById("content");
const hamburger = document.getElementById("hamburger");
hamburger.addEventListener("click", () => {
  sidebar.classList.toggle("closed");
  content.classList.toggle("full");
});

/* ------------------ LOAD SESSIONS AND LOCK TO LATEST ------------------ */
async function loadSessionsAndLock(){
  try {
    // Primary source: exam backend sessions
    let sessions = [];
    try{
      const r1 = await fetch(`${EXAM_API}/session/list`);
      const d1 = await r1.json();
      sessions = d1.sessions || [];
    }catch(_e){}

    // Fallback source: fee backend sessions
    if(!sessions.length){
      const r2 = await fetch(`${FEE_API}/session/list`);
      const d2 = await r2.json();
      sessions = d2.sessions || [];
    }

    if(sessions.length > 0){
      // Pick latest session (or first) as current
      const currentSession = sessions[sessions.length-1];
      sessionSelect.innerHTML = `<option value="${currentSession}">${currentSession}</option>`;
      sessionSelect.disabled = true;
    } else {
      alert("No session available!");
    }
  } catch(e){
    console.error("Failed to load sessions", e);
    alert("Failed to load sessions");
  }
}

/* ------------------ LOAD EXAMS ------------------ */
async function loadExams(){
  const session = sessionSelect.value;  // current session: e.g. "2025_26"
  try {
    const res = await fetch(`${EXAM_API}/exam/list-all`);
    const data = await res.json();
    // Filter exams that belong to the current session only
    EXAMS = (data.exams || []).filter(e => e.session === session);

    examSelect.innerHTML =
      `<option value="">Select Exam</option>` +
      EXAMS.map(e => `<option value="${e.exam_name}">${e.exam_name}</option>`).join("");

    // Optional: auto-select the first exam if exists
    if(EXAMS.length > 0){
      examSelect.value = EXAMS[0].exam_name;
      buildTable();
    }

  } catch(e){
    console.error("Failed to load exams", e);
  }
}

/* ------------------ LOAD CLASSES ------------------ */
async function loadClasses(){
  const session = sessionSelect.value;
  const res = await fetch(`${STUDENT_API}/students?session=${encodeURIComponent(session)}`);
  const data = await res.json();
  const list = Array.isArray(data) ? data : (data.students || []);
  CLASS_LIST = [...new Set(list.map(s=>s.class_name))].filter(Boolean).sort((a,b)=>{
    let n1=parseInt(a), n2=parseInt(b);
    if(!isNaN(n1) && !isNaN(n2)) return n1-n2;
    return a.localeCompare(b);
  });
}

/* ------------------ BUILD TABLE ------------------ */
examSelect.addEventListener("change", buildTable);

async function buildTable(){
  const session = sessionSelect.value;
  const exam = examSelect.value;
  if(!session || !exam) return;

  await loadClasses();
  SUBJECTS_BY_CLASS = {};

  await Promise.all(CLASS_LIST.map(async (cls)=>{
    try {
      const res = await fetch(`${EXAM_API}/exam/get-datesheet?class_name=${encodeURIComponent(cls)}&session=${encodeURIComponent(session)}&exam_name=${encodeURIComponent(exam)}`);
      const data = await res.json();
      SUBJECTS_BY_CLASS[cls] = data.datesheet || [];
    } catch(e){
      SUBJECTS_BY_CLASS[cls] = [];
    }
  }));

  let allSubjectsSet = new Set();
  Object.values(SUBJECTS_BY_CLASS).forEach(arr => arr.forEach(sub => {
    if(sub && sub.subject) allSubjectsSet.add(sub.subject);
  }));
  let allSubjects = Array.from(allSubjectsSet);

  thead.innerHTML = `<tr><th>Class</th>${allSubjects.map(s => `<th>${s}</th>`).join('')}</tr>`;

  tbody.innerHTML = "";
  for(let cls of CLASS_LIST){
    const row = document.createElement("tr");
    row.innerHTML = `<td>${cls}</td>` + allSubjects.map(sub => {
      const existing = (SUBJECTS_BY_CLASS[cls] || []).find(e => e.subject === sub);
      return `<td><input type="date" value="${existing ? existing.date : ''}" id="d_${cls}_${sub.replace(/ /g,'_')}"></td>`;
    }).join('');
    tbody.appendChild(row);
  }
}

/* ------------------ SAVE DATESHEET ------------------ */
async function saveAll(){
  const session = sessionSelect.value;
  const exam = examSelect.value;
  if(!session || !exam) { alert("Select exam"); return; }

  let rows = document.querySelectorAll("#sheetTable tbody tr");
  for(let r of rows){
    const cls = r.children[0].innerText;
    let datesheet = [];
    for(let i=1; i<r.children.length; i++){
      const subject = thead.querySelectorAll("th")[i].innerText;
      const dateVal = r.children[i].querySelector("input").value;
      if(dateVal){
        datesheet.push({subject, date: dateVal, total_marks:100, duration:180});
      }
    }
    if(datesheet.length > 0){
      await fetch(`${EXAM_API}/exam/add-datesheet`, {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({session, class_name:cls, exam_name:exam, datesheet})
      });
    }
  }

  alert("Datesheet saved successfully!");
}

async function downloadPDF(){
  const table = document.getElementById("sheetTable");
  if(!table || !table.querySelector("tbody tr")){
    return alert("No datesheet data to export.");
  }
  const jsPDFCtor = window.jspdf && window.jspdf.jsPDF;
  if(!jsPDFCtor || typeof window.html2canvas === "undefined"){
    return alert("PDF library is not loaded. Refresh and try again.");
  }

  const host = document.createElement("div");
  host.style.position = "fixed";
  host.style.left = "-99999px";
  host.style.top = "0";
  host.style.width = "1600px";
  host.style.background = "#fff";
  host.style.padding = "10px";
  host.innerHTML = `<h3 style="margin:0 0 10px 0;font-family:Poppins,sans-serif;">Datesheet - ${examSelect.value} - ${sessionSelect.value}</h3>`;
  host.appendChild(table.cloneNode(true));
  document.body.appendChild(host);

  const btn = document.querySelector('button[onclick="downloadPDF()"]');
  const oldText = btn ? btn.textContent : "";
  if(btn) btn.textContent = "Generating PDF...";

  try{
    const canvas = await window.html2canvas(host, {scale:2, useCORS:true, backgroundColor:"#fff"});
    const img = canvas.toDataURL("image/jpeg", 0.95);
    const pdf = new jsPDFCtor("l","mm","a4");
    const pageW=297, pageH=210, margin=6, maxW=pageW-margin*2, maxH=pageH-margin*2;
    let w=maxW, h=(canvas.height*w)/canvas.width;
    if(h<=maxH){
      const x=(pageW-w)/2, y=(pageH-h)/2;
      pdf.addImage(img,"JPEG",x,y,w,h);
    }else{
      const pageCanvas=document.createElement("canvas");
      const ctx=pageCanvas.getContext("2d");
      const sliceHeightPx=Math.floor(canvas.width*(maxH/maxW));
      pageCanvas.width=canvas.width;
      let yPx=0, page=0;
      while(yPx<canvas.height){
        const cur=Math.min(sliceHeightPx, canvas.height-yPx);
        pageCanvas.height=cur;
        ctx.clearRect(0,0,pageCanvas.width,pageCanvas.height);
        ctx.drawImage(canvas,0,yPx,canvas.width,cur,0,0,canvas.width,cur);
        const slice=pageCanvas.toDataURL("image/jpeg",0.95);
        const sliceH=(cur*maxW)/canvas.width;
        if(page>0) pdf.addPage();
        pdf.addImage(slice,"JPEG",margin,margin,maxW,sliceH);
        yPx+=cur; page+=1;
      }
    }
    pdf.save(`datesheet_${examSelect.value || "exam"}_${sessionSelect.value || "session"}.pdf`);
  }catch(e){
    console.error(e);
    alert("Unable to generate PDF.");
  }finally{
    if(btn) btn.textContent = oldText || "DOWNLOAD PDF";
    if(host.parentNode) host.parentNode.removeChild(host);
  }
}

// INITIAL LOAD
loadSessionsAndLock().then(loadExams);
</script>

</body>
</html>





