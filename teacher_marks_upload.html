<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Teacher Mark Upload â€“ School ERP</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
    margin:0;
    font-family:Poppins,sans-serif;
    background:#f2f4f7;
    display:flex;
}

/* Hamburger button for mobile */
#hamburger {
    display: none; /* hidden on desktop */
    position: fixed;
    top: 15px;
    left: 15px;
    width: 30px;
    height: 25px;
    cursor: pointer;
    z-index: 1002;
}
#hamburger span {
    display: block;
    height: 3px;
    width: 100%;
    background: white;
    margin-bottom: 5px;
    border-radius: 2px;
}

/* Sidebar */
.sidebar{
    width:240px;
    background:#233465;
    color:white;
    height:100vh;
    position:fixed;
    left:0;
    top:0;
    padding-top:20px;
    transition: transform 0.3s ease;
    z-index: 1000;
}
.sidebar.hidden{
    transform: translateX(-260px);
}
.sidebar.show{
    transform: translateX(0);
}

.sidebar h2{text-align:center;font-size:22px;margin-bottom:25px;}
.sidebar a{display:block;padding:12px 20px;color:white;text-decoration:none;font-size:16px;}
.sidebar a:hover{background:rgba(255,255,255,0.25);}
.sidebar a.active{background:rgba(255,255,255,0.35);}

/* Content */
.content{
    margin-left:240px;
    width:calc(100% - 240px);
    padding:20px;
    transition: margin-left 0.3s ease;
}
.content.shifted{
    margin-left:0;
}

/* Header & main */
header{background:#233465;color:#fff;padding:1rem;text-align:center;font-size:1.5rem;border-radius:8px;}
main{max-width:700px;margin:2rem auto;background:#fff;padding:2rem;border-radius:12px;box-shadow:0 2px 12px rgba(0,0,0,0.1);}
label{display:block;font-weight:600;margin-top:15px;}
select,input{width:100%;padding:10px;margin-top:5px;border:1px solid #ccc;border-radius:6px;}
button{margin-top:20px;width:100%;padding:12px;background:#4f46e5;color:white;border:none;font-size:16px;border-radius:6px;cursor:pointer;}
button:hover{background:#3730a3;}
table{width:100%;border-collapse:collapse;margin-top:20px;}
th,td{border:1px solid #ccc;padding:8px;text-align:center;}
th{background:#233465;color:white;}
.low-mark{background:#f87171;color:white;}
.total-marks{margin-top:10px;font-weight:bold;font-size:1.1rem;}
.export-btn{background:#f59e0b;margin-top:10px;}

/* Responsive for mobile */
@media screen and (max-width: 768px){
    #hamburger { display: block; }
    .sidebar{ transform: translateX(-260px); }
    .sidebar.show{ transform: translateX(0);}
    .content{ margin-left:0; }
    .content.shifted{ margin-left:240px; }
}
</style>
</head>

<body>

<!-- Hamburger button -->
<div id="hamburger">
    <span></span>
    <span></span>
    <span></span>
</div>

<div class="sidebar" id="sidebar">
<h2>School ERP</h2>
<a href="teacher_dashboard.html">Dashboard</a>
<a href="view_notices.html">Notices and Circular</a>
<a href="teacher_my_classes.html">My Time Table</a>
<a href="teacher_attendance.html">Upload Attendance</a>
<a href="teacher_view_datesheet.html">View Datesheet</a>
<a href="teacher_papers.html">Question Papers</a>
<a href="teacher_marks_upload.html"  style="background: rgba(255,255,255,0.25);">Upload Marks</a>
<a href="teacher_leave.html">Leave Permission</a>
</div>

<div class="content" id="content">
<header>Upload Student Marks</header>
<main>

<label>Session</label>
<select id="sessionSelect"></select>

<label>Exam</label>
<select id="examSelect"></select>

<div class="total-marks" id="totalMarks"></div>

<label>Class</label>
<select id="classSelect"></select>

<label>Subject</label>
<select id="subjectSelect"></select>

<button onclick="loadStudents()">Load Students</button>

<div id="tableContainer"></div>

<button onclick="uploadMarks()" style="background:#1e8f3d;">Upload Marks</button>
<button onclick="exportCSV()" class="export-btn">Export CSV</button>

</main>
</div>

<script>
const EXAM_API = "https://exam-backend-ko0t.onrender.com";
const STUDENT_API = "https://students-backend-8mup.onrender.com";

// teacher info (from login)
const TEACHER_ID = localStorage.getItem("teacher_id");
let TEACHER_CLASSES = {}; // { className: [subject1, subject2] }
let EXAMS = [], TOTAL_MARKS = 0;

// ------------------------
// LOAD SESSIONS
// ------------------------
async function loadSessions() {
    try{
        const res = await fetch(`${EXAM_API}/session/list`);
        const data = await res.json();
        sessionSelect.innerHTML = data.sessions.map(s=>`<option>${s}</option>`).join("");
        if(data.sessions.length>0){
            sessionSelect.value = data.sessions[0];
            await loadTeacherClasses();
        }
    }catch(err){
        console.error("Failed to load sessions:",err);
    }
}
loadSessions();
sessionSelect.addEventListener("change", loadTeacherClasses);

// ------------------------
// LOAD TEACHER CLASSES & SUBJECTS
// ------------------------
async function loadTeacherClasses(){
    const session = sessionSelect.value;
    if(!session || !TEACHER_ID) return;

    try{
        const res = await fetch(`${EXAM_API}/timetable/get?session=${encodeURIComponent(session)}&teacher_id=${encodeURIComponent(TEACHER_ID)}`);
        const data = await res.json();
        TEACHER_CLASSES = {};
        if(data.success && Array.isArray(data.timetable)){
            const days = ["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
            data.timetable.forEach(row=>{
                const cls = row.class;
                if(!cls) return;
                if(!TEACHER_CLASSES[cls]) TEACHER_CLASSES[cls] = new Set();
                days.forEach(d=>{
                    if(row[d] && row[d].trim()!=="") TEACHER_CLASSES[cls].add(row[d].trim());
                });
            });
        }

        const classes = Object.keys(TEACHER_CLASSES).sort();
        classSelect.innerHTML = `<option value="">Select Class</option>` + classes.map(c=>`<option value="${c}">${c}</option>`).join("");
        if(classes.length>0) classSelect.value = classes[0];
        await loadSubjects();
        await loadExams();
    }catch(err){
        console.error("Error loading teacher classes:",err);
    }
}
classSelect.addEventListener("change", loadSubjects);

// ------------------------
// LOAD SUBJECTS (teacher-specific)
// ------------------------
async function loadSubjects(){
    const cls = classSelect.value;
    if(!cls) return;
    const subjects = Array.from(TEACHER_CLASSES[cls] || []);
    subjectSelect.innerHTML = subjects.map(s=>`<option>${s}</option>`).join("");
}

// ------------------------
// LOAD EXAMS
// ------------------------
async function loadExams(){
    try{
        const res = await fetch(`${EXAM_API}/exam/list-all`);
        const data = await res.json();
        if(!data.success) return alert("Exam load error");
        EXAMS = data.exams;
        examSelect.innerHTML = `<option value="">Select Exam</option>` + EXAMS.map(e=>`<option value="${e.exam_id}" data-total="${e.total_marks}">${e.exam_name}</option>`).join("");
    }catch(err){
        console.error("Error loading exams:",err);
    }
}
examSelect.addEventListener("change", ()=>{
    const selected = EXAMS.find(e=>e.exam_id==examSelect.value);
    TOTAL_MARKS = selected ? selected.total_marks : 0;
    totalMarks.textContent = selected ? `Total Marks: ${TOTAL_MARKS}` : "";
    loadStudents();
});

// ------------------------
// LOAD STUDENTS + MARKS
// ------------------------
async function loadStudents(){
    const session = sessionSelect.value;
    const cls = classSelect.value;
    const sub = subjectSelect.value;
    const examId = examSelect.value;
    if(!cls||!sub||!examId) return;

    try{
        const res = await fetch(`${STUDENT_API}/students?session=${session}`);
        const students = await res.json();
        const classStudents = students
            .filter(s => s.class_name === cls)
            .sort((a, b) => (parseInt(a.rollno)||0) - (parseInt(b.rollno)||0));

        let html = `<table><tr><th>Roll No</th><th>Name</th><th>Marks</th><th>Percent</th></tr>`;
        classStudents.forEach(s=>{
            html += `<tr>
                <td>${s.rollno}</td>
                <td>${s.student_name}</td>
                <td><input type="number" data-roll="${s.rollno}" min="0"></td>
                <td class="percent-cell"></td>
            </tr>`;
        });
        html += `</table>`;
        document.getElementById("tableContainer").innerHTML = html;

        await loadExistingMarks();
        updatePercentColors();
    }catch(err){
        console.error("Error loading students:",err);
    }
}

// ------------------------
// LOAD EXISTING MARKS
// ------------------------
async function loadExistingMarks(){
    const session = sessionSelect.value;
    const cls = classSelect.value;
    const sub = subjectSelect.value;
    const examId = examSelect.value;
    if(!cls||!sub||!examId) return;
    const examData = EXAMS.find(e=>e.exam_id==examId);
    if(!examData) return;

    try{
        const res = await fetch(`${EXAM_API}/exam/get-marks?session=${session}&class_name=${cls}&exam_name=${examData.exam_name}`);
        const data = await res.json();
        if(!data.success) return;
        data.marks.filter(m=>m.subject===sub).forEach(m=>{
            const input = document.querySelector(`input[data-roll='${m.roll}']`);
            if(input) input.value = m.marks;
        });
        updatePercentColors();
    }catch(err){ console.error(err); }
}

// ------------------------
// UPDATE PERCENT & LOW MARK HIGHLIGHT
// ------------------------
function updatePercentColors(){
    const rows = document.querySelectorAll("#tableContainer table tr");
    rows.forEach((tr,i)=>{
        if(i===0) return;
        const markInput = tr.querySelector("input[data-roll]");
        const percentCell = tr.querySelector(".percent-cell");
        if(markInput){
            const marks = Number(markInput.value);
            const percent = TOTAL_MARKS ? ((marks/TOTAL_MARKS)*100).toFixed(2) : 0;
            percentCell.textContent = percent + "%";
            if(marks < TOTAL_MARKS/3){
                markInput.classList.add("low-mark");
                percentCell.classList.add("low-mark");
            }else{
                markInput.classList.remove("low-mark");
                percentCell.classList.remove("low-mark");
            }
            markInput.addEventListener("input", updatePercentColors);
        }
    });
}

// ------------------------
// UPLOAD MARKS
// ------------------------
async function uploadMarks(){
    const session = sessionSelect.value;
    const examId = examSelect.value;
    const cls = classSelect.value;
    const sub = subjectSelect.value;
    if(!examId||!cls||!sub) return alert("Select exam, class, and subject!");

    const examData = EXAMS.find(e=>e.exam_id==examId);
    if(!examData) return;

    const rows = document.querySelectorAll("input[data-roll]");
    const marksList = Array.from(rows).map(r=>({ roll: r.dataset.roll, subject: sub, marks: r.value || 0 }));

    try{
        const res = await fetch(`${EXAM_API}/exam/add-marks`,{
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body: JSON.stringify({ session, class_name: cls, exam_name: examData.exam_name, marks: marksList })
        });
        const data = await res.json();
        alert(data.message || "Marks uploaded!");
    }catch(err){
        console.error(err);
        alert("Error uploading marks");
    }
}

// ------------------------
// EXPORT CSV
// ------------------------
function exportCSV(){
    const table = document.querySelector("#tableContainer table");
    if(!table) return alert("No data to export!");
    let csv = [];
    const rows = table.querySelectorAll("tr");
    rows.forEach(tr=>{
        const row = [];
        tr.querySelectorAll("th,td").forEach(td=>{
            const input = td.querySelector("input");
            if(input) row.push(input.value); else row.push(td.textContent.trim());
        });
        csv.push(row.join(","));
    });
    const blob = new Blob([csv.join("\n")],{type:"text/csv"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `marks_${Date.now()}.csv`;
    a.click();
    URL.revokeObjectURL(url);
}

// ------------------------
// HAMBURGER TOGGLE
// ------------------------
const hamburger = document.getElementById("hamburger");
const sidebar = document.getElementById("sidebar");
const content = document.getElementById("content");

hamburger.addEventListener("click", ()=>{
    sidebar.classList.toggle("show");
    content.classList.toggle("shifted");
});

content.addEventListener("click", ()=>{
    if(window.innerWidth <= 768 && sidebar.classList.contains("show")){
        sidebar.classList.remove("show");
        content.classList.remove("shifted");
    }
});

// hide sidebar if resizing desktop
window.addEventListener("resize", ()=>{
    if(window.innerWidth > 768){
        sidebar.classList.remove("show");
        content.classList.remove("shifted");
    }
});
</script>

</body>
</html>
