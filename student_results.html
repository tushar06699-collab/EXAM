<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Student Results</title>

<style>
:root{
  --primary:#4e73df;
  --bg:#f5f7fb;
  --card:#ffffff;
  --fail:#ef4444;
  --muted:#6b7280;
  --border:#e5e7eb;
  --pass-bg:#dcfce7;
  --pass-text:#166534;
  --fail-bg:#fee2e2;
  --fail-text:#b91c1c;
}
body{
  margin:0;
  font-family:Poppins,system-ui,sans-serif;
  background:var(--bg);
}

/* HEADER */
header{
  background:var(--primary);
  color:#fff;
  padding:10px 20px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.left{display:flex;align-items:center;gap:10px;}
.menu-btn{font-size:26px;cursor:pointer;}
.student-info{display:flex;align-items:center;gap:10px;}
.student-info img{
  width:38px;height:38px;border-radius:50%;
  border:2px solid #fff;object-fit:cover;
}
.logout{
  background:rgba(255,255,255,.25);
  border:none;color:#fff;
  padding:6px 12px;border-radius:20px;
  cursor:pointer;
}

/* SIDEBAR */
.sidebar{
  position:fixed;top:0;left:-280px;
  width:260px;height:100%;
  background:#fff;z-index:1001;
  padding:20px;transition:.3s;
  box-shadow:2px 0 15px rgba(0,0,0,.2);
}
.sidebar a{
  display:block;padding:12px 0;
  color:#333;text-decoration:none;
  border-bottom:1px solid #eee;
}
.sidebar a:hover{color:var(--primary);}
.overlay{
  position:fixed;inset:0;
  background:rgba(0,0,0,.4);
  display:none;z-index:1000;
}

/* CONTENT */
.container{padding:20px;max-width:1000px;margin:auto;}
.marksheet{
  background:#fff;
  margin:20px auto;
  padding:20px;
  border-radius:12px;
  box-shadow:0 8px 20px rgba(15,23,42,.08);
  border:1px solid var(--border);
}
.marksheet h2{text-align:center;color:var(--primary);}
.info{
  display:flex;flex-wrap:wrap;
  font-size:14px;margin-bottom:12px;
}
.info div{width:48%;margin-bottom:6px;}

table{
  width:100%;border-collapse:collapse;
}
th,td{
  border:1px solid var(--border);
  padding:8px;text-align:center;
}
th{background:#f8fafc;}
.result{text-align:center;font-weight:bold;margin-top:12px;}
.pass{color:var(--pass-text);}
.fail{color:var(--fail-text);}
.status-pill{
  display:inline-block;
  padding:3px 10px;
  border-radius:999px;
  font-weight:600;
  font-size:12px;
}
.status-pass{background:var(--pass-bg);color:var(--pass-text);}
.status-fail{background:var(--fail-bg);color:var(--fail-text);}
.subtle{color:var(--muted);}
</style>
<link rel="stylesheet" href="student_mobile.css"></head>
<body>

<div class="overlay" id="overlay" onclick="closeMenu()"></div>

<div class="sidebar" id="sidebar">
   <h2>Student Menu</h2>
    <a onclick="go('student_portal.html')">Dashboard</a>
    <a onclick="go('student_results.html')">Results</a>
    <a onclick="go('student_timetable.html')">Timetable</a>
    <a onclick="go('student_exams.html')">Exams</a>
    <a onclick="go('student_hall_ticket.html')">Hall Ticket</a>
    <a onclick="go('student_attendance.html')">Attendance</a>
            <a onclick="openPage('student_notices.html')">Notices</a>
    <a onclick="openPage('student_academic_calendar.html')">Academic Calendar</a>
</div>

<header>
  <div class="left">
    <span class="menu-btn" onclick="openMenu()">?</span>
    <h2>Results</h2>
  </div>
  <div class="student-info">
    <img id="headerPhoto" src="images/default.png">
    <span id="headerName">Student</span>
    <button class="logout" onclick="logout()">Logout</button>
  </div>
</header>

<div class="container" id="marksContainer"></div>

<script>
const STUDENT_API="https://student-backend-117372286918.asia-south1.run.app/";
const EXAM_API="https://exam-backend-117372286918.asia-south1.run.app/";

/* AUTH */
if(localStorage.getItem("role")!=="student"){
  location.href="index.html";
}

const studentId = localStorage.getItem("student_id");
if(!studentId) location.href="index.html";

/* LOAD HEADER STUDENT */
fetch(`${EXAM_API}/portal/student/${studentId}`)
.then(r=>r.json())
.then(d=>{
  const s=d.student;
  headerName.innerText=s.name;
  headerPhoto.src=s.photo_url||"images/default.png";
  headerPhoto.onerror=()=>headerPhoto.src="images/default.png";
});

/* LOAD RESULTS */
async function loadMarks(){
  const rawSession = (localStorage.getItem("session") || "").replace(/-/g,"_");
  const p = await (await fetch(`${EXAM_API}/portal/student/${studentId}`)).json();
  if(!p.success || !p.student) return alert("Student not found");

  const profile = p.student;
  if(profile.eligible === false){
    marksContainer.innerHTML = `<div class="marksheet"><h2>Result</h2><div class="result fail">You are not eligible to attend the exam. Result is not released.</div></div>`;
    return;
  }
  if(profile.release_result === false){
    marksContainer.innerHTML = `<div class="marksheet"><h2>Result</h2><div class="result subtle">Result is not released for your profile yet ( Contact To Admin Block) .</div></div>`;
    return;
  }

  const session = rawSession;
  const rollFromProfile = String(profile.roll || "").trim();
  const norm = (v)=>String(v || "").trim().replace(/^0+/, "") || "0";
  const candidateRolls = Array.from(new Set([
    rollFromProfile,
    norm(rollFromProfile)
  ].filter(Boolean)));
  if(!candidateRolls.length){
    marksContainer.innerHTML = `<div class="marksheet"><h2>Result</h2><div class="result subtle">Roll number is not released for your profile.</div></div>`;
    return;
  }
  const studentIds = Array.from(new Set([String(studentId || ""), String(profile.id || "")].filter(Boolean)));

  const exams=(await (await fetch(`${EXAM_API}/exam/list-all`)).json()).exams;

  for(const exam of exams){
    const examSession = String(exam.session || session || "").replace(/-/g,"_");
    if(session && examSession && examSession !== session) continue;
    const allowInternal = !(
      exam.internal_marks === false ||
      exam.internal_marks === "no" ||
      exam.internal_marks === "No" ||
      exam.internal_marks === "false" ||
      exam.internal_marks === 0
    );

    // check publish status
    try{
      const statusRes = await fetch(`${EXAM_API}/result/status?session=${encodeURIComponent(examSession)}&class_name=${encodeURIComponent(profile.class_name)}&exam_name=${encodeURIComponent(exam.exam_name)}`);
      const statusData = await statusRes.json();
      if(!statusData.success || !statusData.published){
        marksContainer.innerHTML+=`
        <div class="marksheet">
          <h2>${exam.exam_name}</h2>
          <div class="result">Result coming soon.</div>
        </div>`;
        continue;
      }
    }catch(e){
      marksContainer.innerHTML+=`
      <div class="marksheet">
        <h2>${exam.exam_name}</h2>
        <div class="result">Result coming soon.</div>
      </div>`;
      continue;
    }

    const r=await fetch(
      `${EXAM_API}/exam/get-marks?session=${examSession}&class_name=${profile.class_name}&exam_name=${exam.exam_name}`
    );
    if(!r.ok) continue;
    const d=await r.json();
    if(!d.success) continue;

    const map={};
    d.marks.forEach(m=>{
      if(!map[m.roll]) map[m.roll]={};
      map[m.roll][m.subject]=m.marks;
    });
    let subs = null;
    for(const rk of candidateRolls){
      if(map[rk]){
        subs = map[rk];
        break;
      }
    }
    if(!subs){
      marksContainer.innerHTML+=`
      <div class="marksheet">
        <h2>${exam.exam_name}</h2>
        <div class="result">Result not uploaded yet.</div>
      </div>`;
      continue;
    }

    const subjects = Object.keys(subs);
    const externalMaxBySubject = {};
    const internalMarksBySubject = {};
    const internalMaxBySubject = {};

    await Promise.all(subjects.map(async (sub)=>{
      externalMaxBySubject[sub] = Number(exam.total_marks || 0);
      internalMarksBySubject[sub] = 0;
      internalMaxBySubject[sub] = 0;

      try{
        const rc = await fetch(`${EXAM_API}/exam/subject-config/get?session=${encodeURIComponent(examSession)}&class_name=${encodeURIComponent(profile.class_name)}&exam_name=${encodeURIComponent(exam.exam_name)}&subject=${encodeURIComponent(sub)}`);
        const dc = await rc.json();
        if(dc.success && dc.config){
          if(dc.config.external_max_marks != null){
            externalMaxBySubject[sub] = Number(dc.config.external_max_marks);
          }
          if(dc.config.internal_max_marks != null){
            internalMaxBySubject[sub] = Number(dc.config.internal_max_marks);
          }
        }
      }catch(e){}

      if(allowInternal){
        try{
          const r1 = await fetch(`${EXAM_API}/internal-marks/list?session=${encodeURIComponent(examSession)}&class_name=${encodeURIComponent(profile.class_name)}&subject=${encodeURIComponent(sub)}&exam_name=${encodeURIComponent(exam.exam_name)}`);
          const d1 = await r1.json();
          let studentInternal = 0;
          if(d1.success && Array.isArray(d1.marks)){
            const row = d1.marks.find(m=>studentIds.includes(String(m.student_id)));
            if(row && row.marks != null) studentInternal = Number(row.marks);
          }
          internalMarksBySubject[sub] = studentInternal;
        }catch(e){
          internalMarksBySubject[sub] = 0;
        }
      }
    }));

    let total=0,totalMax=0,fail=false;
    const rows=subjects.map(sub=>{
      const external = Number(subs[sub] ?? 0);
      const extMax = Number(externalMaxBySubject[sub] || exam.total_marks || 0);
      const internal = allowInternal ? Number(internalMarksBySubject[sub] || 0) : 0;
      const internalMax = allowInternal ? Number(internalMaxBySubject[sub] || 0) : 0;
      const subjectTotal = external + internal;
      const subjectMax = extMax + internalMax;
      const passThreshold = subjectMax > 0 ? Math.ceil(subjectMax * 0.33) : 0;
      const subjectPass = subjectTotal >= passThreshold;

      total += subjectTotal;
      totalMax += subjectMax;
      if(!subjectPass) fail = true;

      return `<tr>
        <td>${sub}</td>
        <td>${external}</td>
        <td>${extMax}</td>
        ${allowInternal ? `<td>${internal}</td><td>${internalMax}</td>` : ``}
        <td>${subjectTotal}</td>
        <td>${subjectMax}</td>
        <td>${subjectPass ? `<span class="status-pill status-pass">PASS</span>` : `<span class="status-pill status-fail">FAIL</span>`}</td>
      </tr>`;
    }).join("");

    marksContainer.innerHTML+=`
    <div class="marksheet">
      <h2>${exam.exam_name}</h2>
      <div class="info">
        <div><b>Name:</b> ${profile.name || ""}</div>
        <div><b>Roll No:</b> ${rollFromProfile || "Not Released"}</div>
        <div><b>Class:</b> ${profile.class_name || ""} ${profile.section || ""}</div>
        <div><b>Session:</b> ${examSession}</div>
      </div>
      <table>
        <tr>
          <th>Subject</th>
          <th>External</th>
          <th>Ext Max</th>
          ${allowInternal ? `<th>Internal</th><th>Int Max</th>` : ``}
          <th>Total</th>
          <th>Total Max</th>
          <th>Status</th>
        </tr>
        ${rows}
      </table>
      <div class="result ${fail?'fail':'pass'}">
        RESULT: ${fail?'FAIL':'PASS'} | ${total}/${totalMax}
      </div>
      <div class="subtle" style="text-align:center;margin-top:6px;">
        ${allowInternal ? "Internal marks included for this exam." : "Internal marks not applicable for this exam."}
      </div>
    </div>`;
  }

  if(!marksContainer.innerHTML.trim()){
    marksContainer.innerHTML = `<div class="marksheet"><h2>Result</h2><div class="result subtle">No published result found for your profile.</div></div>`;
  }
}

loadMarks();

/* UI FUNCTIONS */
function openMenu(){sidebar.style.left="0";overlay.style.display="block";}
function closeMenu(){sidebar.style.left="-280px";overlay.style.display="none";}
function go(p){location.href=p;}
function logout(){localStorage.clear();location.href="index.html";}
</script>

  <script src="student_sidebar_shared.js"></script>
</body>
</html>








