<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Full Datesheet â€“ School ERP</title>
<style>
body {
    margin: 0;
    font-family: Poppins, sans-serif;
    background: #f2f4f7;
}

/* ===== SIDEBAR ===== */
.sidebar {
    width: 240px;
    background: #233465;
    color: white;
    height: 100vh;
    position: fixed;
    top: 0;
    left: 0;
    padding-top: 20px;
    box-shadow: 2px 0 10px rgba(0,0,0,0.1);
}
.sidebar h2 { text-align:center; font-size:22px; margin-bottom:30px; }
.sidebar a {
    display:block; padding:12px 20px; color:white; text-decoration:none;
}
.sidebar a:hover { background:rgba(255,255,255,0.2); }
.sidebar a.active { background:rgba(255,255,255,0.3); }

/* ===== CONTENT ===== */
.content {
    margin-left: 240px;
    padding: 20px;
}
header {
    background:#233465; color:#fff; padding:1rem; text-align:center;
    font-size:1.5rem; border-radius:8px;
}
main {
    max-width:1200px; margin:20px auto; background:#fff;
    padding:20px; border-radius:12px;
    box-shadow:0 2px 12px rgba(0,0,0,0.1);
}
label { font-weight:600; display:block; margin-top:1rem; }
select { padding:10px; width:100%; border-radius:6px; border:1px solid #ccc; }

.sessionBox {
    background:#233465;
    color:white;
    padding:10px 16px;
    width:max-content;
    border-radius:6px;
    font-weight:600;
    margin-bottom:10px;
}

table {
    width:100%; border-collapse:collapse; margin-top:20px;
    font-size:14px;
}
th, td { border:1px solid #ccc; padding:8px; text-align:center; }
th { background:#f0f0f0; }
</style>
</head>

<body>

<!-- SIDEBAR -->
<div class="sidebar">
    <h2>School ERP</h2>
    <a href="teacher_dashboard.html">Dashboard</a>
        <a href="view_notices.html">Notices and Circular</a>
    <a href="teacher_my_classes.html">My Time Table</a>
            <a href="teacher_attendance.html">Upload Attendance</a>
    <a href="teacher_view_datesheet.html" style="background: rgba(255,255,255,0.25);">View Datesheet</a>
    <a href="teacher_papers.html">Question Papers</a>
    <a href="teacher_marks_upload.html">Upload Marks</a>
</div>

<!-- CONTENT -->
<div class="content">

<header>Full Datesheet</header>

<main>

    <div class="sessionBox" id="currentSession">Loading session...</div>

    <label>Select Exam</label>
    <select id="examSelect"></select>

    <table id="fullTable">
        <thead>
            <tr id="tableHeadRow"><th>Date</th></tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>

</main>

</div>

<script>
const EXAM_API = "https://exam-backend-ko0t.onrender.com";
const STUDENT_API = "https://students-backend-8mup.onrender.com";

let CURRENT_SESSION = "";
let CLASSES = [];
let EXAMS = [];

const examSelect = document.getElementById("examSelect");
const tableHeadRow = document.getElementById("tableHeadRow");
const tableBody = document.getElementById("tableBody");
const currentSessionBox = document.getElementById("currentSession");

/* ================================
   LOAD ONLY CURRENT SESSION
   ================================ */
async function loadCurrentSession() {
    let res = await fetch(`${EXAM_API}/session/list`);
    let data = await res.json();

    if (!data.sessions.length) {
        CURRENT_SESSION = "";
        currentSessionBox.innerText = "No Session Found!";
        return;
    }

    // latest added session = LAST INDEX
    CURRENT_SESSION = data.sessions[data.sessions.length - 1];

    currentSessionBox.innerText = "Current Session: " + CURRENT_SESSION;

    await loadClasses();
    await loadExams();
}

/* ================================
   LOAD CLASSES OF CURRENT SESSION
   ================================ */
async function loadClasses() {
    let res = await fetch(`${STUDENT_API}/students?session=${CURRENT_SESSION}`);
    let data = await res.json();

    if (!Array.isArray(data)) data = data.students || [];

    CLASSES = [...new Set(data.map(s => s.class_name).filter(Boolean))];

    CLASSES.sort((a,b)=>{
        let n1 = parseInt(a), n2 = parseInt(b);
        if(!isNaN(n1) && !isNaN(n2)) return n1 - n2;
        return a.localeCompare(b);
    });
}

/* ================================
   LOAD EXAMS FOR THIS SESSION
   ================================ */
async function loadExams() {
    let res = await fetch(`${EXAM_API}/exam/list-all`);
    let data = await res.json();

    EXAMS = (data.exams || []).filter(e => e.session === CURRENT_SESSION);

    examSelect.innerHTML =
        `<option value="">Select Exam</option>` +
        EXAMS.map(e => `<option value="${e.exam_name}">${e.exam_name}</option>`).join("");
}

examSelect.addEventListener("change", loadFullDatesheet);

/* ================================
   LOAD FULL DATE SHEET
   ================================ */
async function loadFullDatesheet() {
    const examName = examSelect.value;
    if (!examName) return;

    tableHeadRow.innerHTML = "<th>Date</th>" + CLASSES.map(c => `<th>${c}</th>`).join("");

    let result = {};

    for (let cls of CLASSES) {
        let res = await fetch(`${EXAM_API}/exam/get-datesheet?class_name=${cls}&session=${CURRENT_SESSION}&exam_name=${examName}`);
        let data = await res.json();

        (data.datesheet || []).forEach(item => {
            if (!result[item.date]) result[item.date] = {};
            if (!result[item.date][cls]) result[item.date][cls] = [];
            result[item.date][cls].push(item.subject);
        });
    }

    tableBody.innerHTML = "";
    Object.keys(result).sort().forEach(date => {
        let tr = `<tr><td>${date}</td>`;
        CLASSES.forEach(cls => {
            tr += `<td>${result[date][cls] ? result[date][cls].join(", ") : ""}</td>`;
        });
        tr += "</tr>";
        tableBody.innerHTML += tr;
    });
}

window.onload = loadCurrentSession;
</script>

</body>
</html>
