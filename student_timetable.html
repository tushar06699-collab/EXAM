<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My Timetable</title>

<style>
:root{
    --primary:#4e73df;
    --bg:#f5f7fb;
    --text:#333;
}
body{
    margin:0;
    font-family:Poppins,system-ui,sans-serif;
    background:var(--bg);
}

/* HEADER */
header{
    background:var(--primary);
    color:#fff;
    padding:10px 20px;
    display:flex;
    justify-content:space-between;
    align-items:center;
}
.menu-btn{font-size:26px;cursor:pointer;}
.student-info{display:flex;align-items:center;gap:10px;}
.student-info img{
    width:38px;height:38px;border-radius:50%;
    border:2px solid #fff;object-fit:cover;
}
.logout{
    background:rgba(255,255,255,.25);
    border:none;color:white;
    padding:6px 12px;border-radius:20px;
}

/* SIDEBAR */
.sidebar{
    position:fixed;top:0;left:-280px;
    width:260px;height:100%;
    background:#fff;padding:20px;
    box-shadow:2px 0 15px rgba(0,0,0,.2);
    transition:.3s;z-index:1001;
}
.sidebar a{display:block;padding:12px 0;text-decoration:none;color:#333;}
.sidebar a.active{font-weight:600;color:var(--primary);}

.overlay{
    position:fixed;inset:0;
    background:rgba(0,0,0,.4);
    display:none;z-index:1000;
}

/* MAIN */
.container{max-width:1100px;margin:auto;padding:20px;}
.info{display:flex;justify-content:space-between;font-weight:600;margin-bottom:15px;}

table{
    width:100%;border-collapse:collapse;
    background:#fff;border-radius:10px;
    overflow:hidden;box-shadow:0 3px 10px rgba(0,0,0,.1);
}
th,td{border:1px solid #ddd;padding:10px;text-align:center;}
th{background:var(--primary);color:#fff;}
tr:nth-child(even){background:#f4f6fb;}
.lunch{background:#eee;font-weight:bold;}
.cell b{display:block;}
</style>
</head>

<body>

<div class="overlay" id="overlay" onclick="closeMenu()"></div>

<div class="sidebar" id="sidebar">
    <h2>Student Menu</h2>
    <a onclick="openPage('student_portal.html')">Dashboard</a>
    <a onclick="openPage('student_results.html')">Results</a>
    <a class="active">Timetable</a>
    <a onclick="openPage('student_exams.html')">Exams</a>
    <a onclick="openPage('student_hall_ticket.html')">Hall Ticket</a>
    <a onclick="openPage('student_attendance.html')">Attendance</a>
    <a onclick="openPage('student_notices.html')">Notices</a>
    <a onclick="openPage('student_academic_calendar.html')">Academic Calendar</a>
    <hr>
</div>

<header>
    <div>
        <span class="menu-btn" onclick="openMenu()">☰</span>
        <span style="font-size:20px;margin-left:10px;">My Timetable</span>
    </div>
    <div class="student-info">
        <img id="headerPhoto" src="images/default.png">
        <span id="headerName">Student</span>
        <button class="logout" onclick="logout()">Logout</button>
    </div>
</header>

<div class="container">

<div class="info">
    <span id="classInfo"></span>
    <span id="sessionInfo">Loading session...</span>
</div>

<table>
<thead>
<tr>
    <th>Period</th>
    <th>Monday</th>
    <th>Tuesday</th>
    <th>Wednesday</th>
    <th>Thursday</th>
    <th>Friday</th>
    <th>Saturday</th>
</tr>
</thead>
<tbody id="timetableBody"></tbody>
</table>

</div>

<script>
/* ========= AUTH ========= */
if(localStorage.getItem("role") !== "student"){
    location.href="index.html";
}

const studentId = localStorage.getItem("student_id");
const studentClass = localStorage.getItem("class");

if(!studentId || !studentClass){
    location.href="index.html";
}

/* ========= GLOBAL ========= */
const API = "https://exam-backend-ko0t.onrender.com";
let CURRENT_SESSION = "";

/* ========= LOAD STUDENT BASIC ========= */
fetch(`${API}/portal/student/${studentId}`)
.then(r=>r.json())
.then(d=>{
    if(!d.success) throw "";
    headerName.innerText = d.student.name;
    headerPhoto.src = d.student.photo_url || "images/default.png";
    document.getElementById("classInfo").innerText =
        `Class: ${studentClass}`;
});

/* ========= LOAD SESSION FROM BACKEND ========= */
async function loadSession(){
    const res = await fetch(`${API}/session/list`);
    const data = await res.json();

    if(!data.sessions.length){
        document.getElementById("sessionInfo").innerText = "Session not found";
        return;
    }

    CURRENT_SESSION = data.sessions[data.sessions.length - 1];
    document.getElementById("sessionInfo").innerText =
        "Session: " + CURRENT_SESSION;

    loadTimetable(); //  only now
}

/* ========= TIMETABLE ========= */
const periods = [
    { label:"Period 1", num:1 },
    { label:"Period 2", num:2 },
    { label:"Period 3", num:3 },
    { label:"Period 4", num:4 },
    { label:"Lunch", num:"LUNCH" },
    { label:"Period 5", num:5 },
    { label:"Period 6", num:6 },
    { label:"Period 7", num:7 },
    { label:"Period 8", num:8 }
];
const days = ["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];

async function loadTimetable(){
    const res = await fetch(
        `${API}/timetable/classwise?session=${CURRENT_SESSION}&class_name=${studentClass}`
    );
    const data = await res.json();
    renderTable(data.timetable || []);
}

function renderTable(data){
    const body = document.getElementById("timetableBody");
    body.innerHTML = "";

    periods.forEach(p=>{
        let row = `<tr><td><b>${p.label}</b></td>`;

        if(p.label==="Lunch"){
            row += `<td colspan="6" class="lunch">Lunch Break</td></tr>`;
            body.innerHTML += row;
            return;
        }

        days.forEach(day=>{
            const e = data.find(x=>Number(x.period)===p.num && x[day]);
            if(e){
                const [t,s] = e[day].split(" - ");
                row += `<td class="cell"><b>${s}</b>${t}</td>`;
            } else row += `<td></td>`;
        });

        row += "</tr>";
        body.innerHTML += row;
    });
}

/* ========= UI ========= */
function openMenu(){
    sidebar.style.left="0";
    overlay.style.display="block";
}
function closeMenu(){
    sidebar.style.left="-280px";
    overlay.style.display="none";
}
function openPage(p){location.href=p;}
function logout(){
    localStorage.clear();
    location.href="index.html";
}

/* ========= INIT ========= */
loadSession();
</script>

</body>
</html>






