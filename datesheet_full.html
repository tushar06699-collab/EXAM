<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Full Datesheet - School ERP</title>
<style>
body {
    margin: 0;
    font-family: Poppins, sans-serif;
    background: #f2f4f7;
}

/* ===== SIDEBAR ===== */
.sidebar {
    width: 240px;
    background: #233465;
    color: white;
    height: 100vh;
    position: fixed;
    top: 0;
    left: 0;
    padding-top: 20px;
    box-shadow: 2px 0 10px rgba(0,0,0,0.1);
}
.sidebar h2 { text-align:center; font-size:22px; margin-bottom:30px; }
.sidebar a {
    display:block; padding:12px 20px; color:white; text-decoration:none;
}
.sidebar a:hover { background:rgba(255,255,255,0.2); }
.sidebar a.active { background:rgba(255,255,255,0.3); }

/* ===== CONTENT ===== */
.content {
    margin-left: 240px;
    padding: 20px;
}
header {
    background:#233465; color:#fff; padding:1rem; text-align:center;
    font-size:1.5rem; border-radius:8px;
}
main {
    max-width:1200px; margin:20px auto; background:#fff;
    padding:20px; border-radius:12px;
    box-shadow:0 2px 12px rgba(0,0,0,0.1);
}
label { font-weight:600; display:block; margin-top:1rem; }
select { padding:10px; width:100%; border-radius:6px; border:1px solid #ccc; }
button{
    margin-top:12px;
    padding:10px 12px;
    border:none;
    border-radius:6px;
    background:#0f766e;
    color:#fff;
    cursor:pointer;
}
.btn-csv{background:#1e8f3d;}

.sessionBox {
    background:#233465;
    color:white;
    padding:10px 16px;
    width:max-content;
    border-radius:6px;
    font-weight:600;
    margin-bottom:10px;
}

table {
    width:100%; border-collapse:collapse; margin-top:20px;
    font-size:14px;
}
th, td { border:1px solid #ccc; padding:8px; text-align:center; }
th { background:#f0f0f0; }
</style>
</head>

<body>

<!-- SIDEBAR -->
<div class="sidebar">
    <h2>School ERP</h2>
    <a href="dashboard.html">Dashboard</a>
    <a href="exam_create.html">Exam Create</a>
    <a href="datesheet.html">Make Datesheet</a>
    <a class="active" href="datesheet_full.html">See Datesheet</a>
</div>

<!-- CONTENT -->
<div class="content">

<header>Full Datesheet</header>

<main>

    <div class="sessionBox" id="currentSession">Loading session...</div>

    <label>Select Exam</label>
    <select id="examSelect"></select>
    <button class="btn-csv" onclick="exportCSV()">Export CSV</button>
    <button onclick="downloadPDF()">Download PDF</button>

    <table id="fullTable">
        <thead>
            <tr id="tableHeadRow"><th>Date</th></tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>

</main>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
const EXAM_API = "https://exam-backend-ko0t.onrender.com";
const STUDENT_API = "https://students-backend-8mup.onrender.com";

let CURRENT_SESSION = "";
let CLASSES = [];
let EXAMS = [];

const examSelect = document.getElementById("examSelect");
const tableHeadRow = document.getElementById("tableHeadRow");
const tableBody = document.getElementById("tableBody");
const currentSessionBox = document.getElementById("currentSession");

/* ================================
   LOAD ONLY CURRENT SESSION
   ================================ */
async function loadCurrentSession() {
    let res = await fetch(`${EXAM_API}/session/list`);
    let data = await res.json();

    if (!data.sessions.length) {
        CURRENT_SESSION = "";
        currentSessionBox.innerText = "No Session Found!";
        return;
    }

    // latest added session = LAST INDEX
    CURRENT_SESSION = data.sessions[data.sessions.length - 1];

    currentSessionBox.innerText = "Current Session: " + CURRENT_SESSION;

    await loadClasses();
    await loadExams();
}

/* ================================
   LOAD CLASSES OF CURRENT SESSION
   ================================ */
async function loadClasses() {
    let res = await fetch(`${STUDENT_API}/students?session=${CURRENT_SESSION}`);
    let data = await res.json();

    if (!Array.isArray(data)) data = data.students || [];

    CLASSES = [...new Set(data.map(s => s.class_name).filter(Boolean))];

    CLASSES.sort((a,b)=>{
        let n1 = parseInt(a), n2 = parseInt(b);
        if(!isNaN(n1) && !isNaN(n2)) return n1 - n2;
        return a.localeCompare(b);
    });
}

/* ================================
   LOAD EXAMS FOR THIS SESSION
   ================================ */
async function loadExams() {
    let res = await fetch(`${EXAM_API}/exam/list-all`);
    let data = await res.json();

    EXAMS = (data.exams || []).filter(e => e.session === CURRENT_SESSION);

    examSelect.innerHTML =
        `<option value="">Select Exam</option>` +
        EXAMS.map(e => `<option value="${e.exam_name}">${e.exam_name}</option>`).join("");
}

examSelect.addEventListener("change", loadFullDatesheet);

/* ================================
   LOAD FULL DATE SHEET
   ================================ */
async function loadFullDatesheet() {
    const examName = examSelect.value;
    if (!examName) return;

    tableHeadRow.innerHTML = "<th>Date</th>" + CLASSES.map(c => `<th>${c}</th>`).join("");

    let result = {};

    for (let cls of CLASSES) {
        let res = await fetch(`${EXAM_API}/exam/get-datesheet?class_name=${cls}&session=${CURRENT_SESSION}&exam_name=${examName}`);
        let data = await res.json();

        (data.datesheet || []).forEach(item => {
            if (!result[item.date]) result[item.date] = {};
            if (!result[item.date][cls]) result[item.date][cls] = [];
            result[item.date][cls].push(item.subject);
        });
    }

    tableBody.innerHTML = "";
    Object.keys(result).sort().forEach(date => {
        let tr = `<tr><td>${date}</td>`;
        CLASSES.forEach(cls => {
            tr += `<td>${result[date][cls] ? result[date][cls].join(", ") : ""}</td>`;
        });
        tr += "</tr>";
        tableBody.innerHTML += tr;
    });
}

async function downloadPDF(){
    const table = document.getElementById("fullTable");
    if(!table || !table.querySelector("tbody tr")){
        return alert("No datesheet data to export.");
    }
    const jsPDFCtor = window.jspdf && window.jspdf.jsPDF;
    if(!jsPDFCtor || typeof window.html2canvas === "undefined"){
        return alert("PDF library is not loaded. Refresh and try again.");
    }

    const host = document.createElement("div");
    host.style.position = "fixed";
    host.style.left = "-99999px";
    host.style.top = "0";
    host.style.width = "1600px";
    host.style.background = "#fff";
    host.style.padding = "10px";
    host.style.fontFamily = "Poppins, sans-serif";
    host.style.fontSize = "11px";
    host.innerHTML = `<h3 style="margin:0 0 10px 0;font-family:Poppins,sans-serif;">Full Datesheet - ${examSelect.value || ""} - ${CURRENT_SESSION || ""}</h3>`;
    const tableClone = table.cloneNode(true);
    tableClone.style.fontSize = "10px";
    tableClone.querySelectorAll("th,td").forEach(cell=>{
        cell.style.padding = "4px";
        cell.style.fontSize = "10px";
        cell.style.whiteSpace = "nowrap";
    });
    host.appendChild(tableClone);
    document.body.appendChild(host);

    const btn = document.querySelector('button[onclick="downloadPDF()"]');
    const oldText = btn ? btn.textContent : "";
    if(btn) btn.textContent = "Generating PDF...";

    try{
        const canvas = await window.html2canvas(host, {scale:2, useCORS:true, backgroundColor:"#fff"});
        const img = canvas.toDataURL("image/jpeg", 0.95);
        const pdf = new jsPDFCtor("l","mm","a4");
        const pageW=297, pageH=210, margin=6, maxW=pageW-margin*2, maxH=pageH-margin*2;
        let w=maxW, h=(canvas.height*w)/canvas.width;
        if(h<=maxH){
            const x=(pageW-w)/2, y=(pageH-h)/2;
            pdf.addImage(img,"JPEG",x,y,w,h);
        }else{
            const pageCanvas=document.createElement("canvas");
            const ctx=pageCanvas.getContext("2d");
            const sliceHeightPx=Math.floor(canvas.width*(maxH/maxW));
            pageCanvas.width=canvas.width;
            let yPx=0, page=0;
            while(yPx<canvas.height){
                const cur=Math.min(sliceHeightPx, canvas.height-yPx);
                pageCanvas.height=cur;
                ctx.clearRect(0,0,pageCanvas.width,pageCanvas.height);
                ctx.drawImage(canvas,0,yPx,canvas.width,cur,0,0,canvas.width,cur);
                const slice=pageCanvas.toDataURL("image/jpeg",0.95);
                const sliceH=(cur*maxW)/canvas.width;
                if(page>0) pdf.addPage();
                pdf.addImage(slice,"JPEG",margin,margin,maxW,sliceH);
                yPx+=cur; page+=1;
            }
        }
        pdf.save(`full_datesheet_${examSelect.value || "exam"}_${CURRENT_SESSION || "session"}.pdf`);
    }catch(e){
        console.error(e);
        alert("Unable to generate PDF.");
    }finally{
        if(btn) btn.textContent = oldText || "Download PDF";
        if(host.parentNode) host.parentNode.removeChild(host);
    }
}

function exportCSV(){
    const table = document.getElementById("fullTable");
    if(!table || !table.querySelector("tbody tr")){
        return alert("No datesheet data to export.");
    }

    const rows = [];
    table.querySelectorAll("tr").forEach(tr=>{
        const cols = [];
        tr.querySelectorAll("th,td").forEach(td=>{
            const text = (td.innerText || "").replace(/\n/g, " ").replace(/,/g, " ");
            cols.push(text.trim());
        });
        rows.push(cols.join(","));
    });

    const blob = new Blob([rows.join("\n")], {type:"text/csv"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `full_datesheet_${examSelect.value || "exam"}_${CURRENT_SESSION || "session"}.csv`;
    a.click();
    URL.revokeObjectURL(url);
}

window.onload = loadCurrentSession;
</script>

</body>
</html>





