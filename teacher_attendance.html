<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Teacher Attendance - School ERP</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
    margin:0;
    font-family:Poppins,sans-serif;
    background:#ffffff;
    display:flex;
}

/* ---------- Hamburger ---------- */
#hamburger{
    display:none;
    position:fixed;
    top:15px;
    left:15px;
    width:30px;
    cursor:pointer;
    z-index:1002;
}
#hamburger span{
    display:block;
    height:3px;
    background:white;
    margin:5px 0;
    border-radius:2px;
}

/* ---------- Sidebar ---------- */
.sidebar{
    width:240px;
    background:#233465;
    color:white;
    height:100vh;
    position:fixed;
    left:0;
    top:0;
    padding-top:20px;
    transition:transform 0.3s ease;
    z-index:1000;
}
.sidebar.hidden{
    transform:translateX(-260px);
}
.sidebar.show{
    transform:translateX(0);
}

.sidebar h2{text-align:center;font-size:22px;margin-bottom:25px;}
.sidebar a{display:block;padding:12px 20px;color:white;text-decoration:none;font-size:16px;}
.sidebar a:hover,.sidebar a.active{background:rgba(255,255,255,0.25);}

/* ---------- Content ---------- */
.content{
    margin-left:240px;
    width:calc(100% - 240px);
    padding:20px;
    transition:margin-left 0.3s ease;
}
.content.shifted{
    margin-left:0;
    width:100%;
}

/* ---------- Main ---------- */
header{
    background:#233465;
    color:#fff;
    padding:1rem;
    text-align:center;
    font-size:1.5rem;
    border-radius:8px;
}
main{
    max-width:750px;
    margin:2rem auto;
    background:#ffffff;
    padding:2rem;
    border-radius:0;
}

/* ---------- Form ---------- */
label{display:block;font-weight:600;margin-top:15px;}
select,input{
    width:100%;
    padding:10px;
    margin-top:5px;
    border:1px solid #ccc;
    border-radius:6px;
}
button{
    margin-top:20px;
    width:100%;
    padding:12px;
    background:#4f46e5;
    color:white;
    border:none;
    font-size:16px;
    border-radius:6px;
    cursor:pointer;
}
button:hover{background:#3730a3;}

/* ---------- Table ---------- */
#tableContainer{
    width:100%;
    overflow-x:auto;   /*  mobile fix */
    background:white;
}
table{
    width:100%;
    min-width:600px;   /*  prevents table shrinking */
    border-collapse:collapse;
    margin-top:20px;
    background:white;
}
th,td{
    border:1px solid #ccc;
    padding:8px;
    text-align:center;
}
th{
    background:#233465;
    color:white;
}
.attendance-select{width:120px;}

/* ---------- Mobile ---------- */
@media (max-width:768px){
    #hamburger{display:block;}

    .sidebar{
        transform:translateX(-260px);
    }
    .sidebar.show{
        transform:translateX(0);
    }

    .content{
        margin-left:0;
        width:100%;
    }

    main{
        margin:1rem;
        padding:1rem;
    }
}

</style>
</head>

<body>
<!-- Hamburger button -->
<div id="hamburger">
    <span></span>
    <span></span>
    <span></span>
</div>

<div class="sidebar">
<h2>Teacher ERP</h2>
    <a href="teacher_dashboard.html">Dashboard</a>
<a href="view_notices.html">Notices and Circular</a>
<a href="teacher_my_classes.html">My Time Table</a>
<a href="teacher_attendance.html"style="background: rgba(255,255,255,0.25);">Upload Student Attendance</a>
<a href="teacher_view_datesheet.html">View Datesheet</a>
<a href="teacher_papers.html">Upload Question Papers</a>
<a href="teacher_internal_marks_upload.html">Upload Internal Marks</a>
<a href="teacher_marks_upload.html">Upload External Marks</a>
<a href="teacher_leave.html">Leave Permission</a>
</div>

<div class="content">
<header>Upload Attendance</header>

<main>
<label>Session</label>
<select id="sessionSelect"></select>

<label>Class</label>
<select id="classSelect"></select>

<label>Date</label>
<input type="date" id="attendanceDate">

<button onclick="loadStudents()">Load Students</button>

<div id="tableContainer"></div>

<button onclick="uploadAttendance()" style="background:#1e8f3d;">Save Attendance</button>
</main>
</div>

<script>
const EXAM_API = "https://exam-backend-ko0t.onrender.com";
const STUDENT_API = "https://students-backend-8mup.onrender.com";

const sessionSelect = document.getElementById("sessionSelect");
const classSelect = document.getElementById("classSelect");
const attendanceDate = document.getElementById("attendanceDate");

const TEACHER_ID = localStorage.getItem("teacher_id");

function normalizedStudentId(student){
    const raw = student?._id ?? student?.id ?? student?.student_id ?? "";
    if(typeof raw === "string") return raw;
    if(raw && typeof raw === "object"){
        if(typeof raw.$oid === "string") return raw.$oid;
        if(typeof raw.oid === "string") return raw.oid;
        if(typeof raw.id === "string") return raw.id;
    }
    return String(raw || "");
}

/* ------------------ TODAY DATE ------------------ */
window.addEventListener("DOMContentLoaded", () => {
    const t = new Date();
    attendanceDate.value = t.toISOString().split("T")[0];
    attendanceDate.max = attendanceDate.value;
});

/* ------------------ LOAD SESSIONS ------------------ */
async function loadSessions(){
    const res = await fetch(`${EXAM_API}/session/list`);
    const data = await res.json();

    sessionSelect.innerHTML = `<option value="">Select Session</option>`;
    data.sessions.forEach(s=>{
        sessionSelect.innerHTML += `<option value="${s}">${s}</option>`;
    });

    if(data.sessions.length){
        sessionSelect.value = data.sessions[0];
        loadTeacherClasses();
    }
}
loadSessions();

sessionSelect.addEventListener("change", loadTeacherClasses);

/* ------------------ LOAD TEACHER CLASSES ------------------ */
async function loadTeacherClasses(){
    if(!TEACHER_ID) return;

    const session = sessionSelect.value;
    const res = await fetch(
        `${EXAM_API}/timetable/get?session=${session}&teacher_id=${TEACHER_ID}`
    );
    const data = await res.json();

    const classes = new Set();
    if(data.success){
        data.timetable.forEach(t=>{
            if(t.class) classes.add(t.class);
        });
    }

    classSelect.innerHTML = `<option value="">Select Class</option>`;
    [...classes].forEach(c=>{
        classSelect.innerHTML += `<option value="${c}">${c}</option>`;
    });
}

/* ------------------ LOAD STUDENTS ------------------ */
async function loadStudents(){
    const session = sessionSelect.value;
    const cls = classSelect.value;
    const date = attendanceDate.value;

    if(!session || !cls || !date){
        alert("Select all fields");
        return;
    }

    const res = await fetch(`${STUDENT_API}/students?session=${session}`);
    const students = await res.json();

    const classStudents = students
        .filter(s => s.class_name === cls)
        .sort((a,b) => (parseInt(a.rollno)||0) - (parseInt(b.rollno)||0));

    if(!classStudents.length){
        alert("No students found");
        return;
    }

    let existingAttendance = {};
    const ares = await fetch(
        `${EXAM_API}/attendance/list?session=${encodeURIComponent(session)}&class_name=${encodeURIComponent(cls)}&date=${encodeURIComponent(date)}`
    );
    const adata = await ares.json();

    if(adata.success){
        adata.attendance.forEach(a=>{
            existingAttendance[String(a.student_id)] = a.status;
        });
    }

    let html = `<table>
        <tr><th>Roll No</th><th>Name</th><th>Status</th></tr>`;

    classStudents.forEach(s=>{
        const sid = normalizedStudentId(s);
        const status = existingAttendance[String(sid)] || "present";
        html += `
        <tr>
            <td>${s.rollno}</td>
            <td>${s.student_name}</td>
            <td>
                <select class="attendance-select" data-student-id="${sid}" data-student-roll="${s.rollno || ""}">
                    <option value="present" ${status==="present"?"selected":""}>Present</option>
                    <option value="absent" ${status==="absent"?"selected":""}>Absent</option>
                    <option value="leave" ${status==="leave"?"selected":""}>Leave</option>
                </select>
            </td>
        </tr>`;
    });

    html += `</table>`;
    document.getElementById("tableContainer").innerHTML = html;
}

/* ------------------ SAVE ATTENDANCE ------------------ */
async function uploadAttendance(){
    const session = sessionSelect.value;
    const class_name = classSelect.value;
    const date = attendanceDate.value;
    if(!session || !class_name || !date) return alert("Select session, class and date");

    const attendance = [...document.querySelectorAll(".attendance-select")]
        .map(s => ({
            student_id: s.dataset.studentId,
            student_roll: s.dataset.studentRoll || "",
            status: s.value
        }));
    if(!attendance.length) return alert("Load students first");

    const res = await fetch(`${EXAM_API}/attendance/save`,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({session,class_name,date,attendance})
    });

    const data = await res.json().catch(() => ({}));
    if(!res.ok || data.success === false){
        alert("Failed to save attendance: " + (data.message || ("HTTP " + res.status)));
        return;
    }
    alert("Attendance saved successfully");
}

const hamburger = document.getElementById("hamburger");
const sidebar = document.querySelector(".sidebar");
const content = document.querySelector(".content");

hamburger.addEventListener("click", ()=>{
    sidebar.classList.toggle("show");
});

content.addEventListener("click", ()=>{
    if(window.innerWidth <= 768 && sidebar.classList.contains("show")){
        sidebar.classList.remove("show");
    }
});

window.addEventListener("resize", ()=>{
    if(window.innerWidth > 768){
        sidebar.classList.remove("show");
    }
});


</script>

  <script src="teacher_sidebar_shared.js"></script>
</body>
</html>





