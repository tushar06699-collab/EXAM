<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>View Exam Papers â€“ School ERP</title>
<style>
body {
    margin: 0;
    font-family: Poppins,sans-serif;
    background: #f2f4f7;
    display: flex;
}

/* Sidebar */
.sidebar {
    width: 240px;
    background: #233465;
    color: white;
    height: 100vh;
    position: fixed;
    left: 0;
    top: 0;
    padding-top: 20px;
}
.sidebar h2 { text-align: center; font-size: 22px; margin-bottom: 25px; }
.sidebar a { display: block; padding: 12px 20px; color: white; text-decoration: none; font-size: 16px; }
.sidebar a:hover { background: rgba(255,255,255,0.25); }
.sidebar a.active { background: rgba(255,255,255,0.35); }

/* Page Content */
.content {
    margin-left: 240px;
    width: calc(100% - 240px);
    padding: 20px;
}
header {
    background:#233465;
    color:#fff;
    padding:1rem;
    text-align:center;
    font-size:1.5rem;
    border-radius:8px;
}
main {
    margin-top:20px;
}
#grid {
    display: grid;
    grid-template-columns: repeat(auto-fill,minmax(200px,1fr));
    gap: 20px;
    margin-top: 20px;
}
.class-box {
    background:#fff;
    padding:15px;
    border-radius:8px;
    box-shadow:0 2px 8px rgba(0,0,0,0.1);
}
.class-box h3 {
    text-align:center;
    margin-bottom:10px;
    font-size:18px;
    color:#233465;
}
.subject {
    margin-bottom:10px;
    padding:8px;
    border-radius:6px;
    background:#f3f4f6;
    display:flex;
    justify-content: space-between;
    align-items: center;
}
.subject a {
    color:#4f46e5;
    font-weight:600;
    text-decoration:none;
}
.subject a:hover {
    text-decoration:underline;
}
button.delete-paper {
    background:#d14343;
    border:none;
    color:white;
    padding:3px 6px;
    border-radius:4px;
    cursor:pointer;
    font-size:12px;
}
button.delete-paper:hover {
    background:#a82f2f;
}
</style>
</head>
<body>

<div class="sidebar">
    <h2>School ERP</h2>
    <a href="dashboard.html">Dashboard</a>
    <a href="exam_paper.html">Upload Papers</a>
    <a href="generate_rollno.html">Exam Roll No List</a>
    <a class="active" href="get_exam_paper.html">Uploaded Exam Papers</a>
</div>

<div class="content">
<header>View Uploaded Exam Papers</header>
<main>
    <label>Session</label>
    <select id="sessionSelect"></select>

    <label>Exam</label>
    <select id="examSelect"></select>

    <div id="grid"></div>
</main>
</div>

<script>
const EXAM_API = "https://exam-backend-ko0t.onrender.com";
const STUDENT_API = "https://students-backend-8mup.onrender.com";

let EXAMS = [];
let SESSION = "";

// -------------------------
// LOAD SESSIONS
// -------------------------
async function loadSessions(){
    const res = await fetch(`${EXAM_API}/session/list`);
    const data = await res.json();
    sessionSelect.innerHTML = data.sessions.map(s=>`<option value="${s}">${s}</option>`).join("");
    if(data.sessions.length>0){
        SESSION = data.sessions[0];
        sessionSelect.value = SESSION;
        loadExams();
        loadGrid();
    }
}
loadSessions();
sessionSelect.addEventListener("change", ()=>{
    SESSION = sessionSelect.value;
    loadExams();
    loadGrid();
});

// -------------------------
// LOAD EXAMS
// -------------------------
async function loadExams(){
    const res = await fetch(`${EXAM_API}/exam/list-all`);
    const data = await res.json();
    EXAMS = data.exams || [];
    examSelect.innerHTML = `<option value="">Select Exam</option>` +
        EXAMS.map(e=>`<option value="${e.exam_id}">${e.exam_name}</option>`).join("");
    examSelect.addEventListener("change", loadGrid);
}

// -------------------------
// LOAD GRID OF CLASSES & SUBJECTS
// -------------------------
async function loadGrid(){
    const examId = examSelect.value;
    const examData = EXAMS.find(e=>e.exam_id==examId);
    if(!SESSION || !examData) return;

    try {
        // Fetch all students for session
        const res = await fetch(`${STUDENT_API}/students?session=${SESSION}`);
        const students = await res.json();
        let classes = [...new Set(students.map(s=>s.class_name).filter(Boolean))];

        // Sort classes in 1st â†’ 12th sequence
        const order = ["1st","2nd","3rd","4th","5th","6th","7th","8th","9th","10th","11th","12th"];
        classes.sort((a,b)=>{
            const idxA = order.findIndex(o=>a.startsWith(o));
            const idxB = order.findIndex(o=>b.startsWith(o));
            if(idxA!==idxB) return idxA - idxB;
            return a.localeCompare(b);
        });

        const grid = document.getElementById("grid");
        grid.innerHTML = "";

        for(let cls of classes){
            const subRes = await fetch(`${EXAM_API}/exam/subjects/get?session=${SESSION}&class_name=${encodeURIComponent(cls)}`);
            const subData = await subRes.json();
            const subjects = subData.success ? subData.subjects : [];

            const box = document.createElement("div");
            box.className = "class-box";
            box.innerHTML = `<h3>${cls}</h3>`;

            for(let sub of subjects){
                const url = `${EXAM_API}/exam/get-paper?session=${SESSION}&class_name=${encodeURIComponent(cls)}&exam_name=${encodeURIComponent(examData.exam_name)}&subject=${encodeURIComponent(sub)}`;
                
                const headRes = await fetch(url, { method:"HEAD" });
                const div = document.createElement("div");
                div.className = "subject";

                if(headRes.ok){
                    div.innerHTML = `<a href="${url}" target="_blank">ðŸ“„ ${sub}</a> 
                        <button class="delete-paper" onclick="deletePaper('${cls}','${sub}','${examData.exam_name}',this)">Delete</button>`;
                } else {
                    div.innerHTML = `<span style="color:red;">${sub} âŒ</span>`;
                }

                box.appendChild(div);
            }

            grid.appendChild(box);
        }

    } catch(e){
        console.error("Error loading grid:", e);
        document.getElementById("grid").innerHTML = "<p style='color:red;'>Failed to load classes/subjects.</p>";
    }
}

// -------------------------
// DELETE PAPER
// -------------------------
async function deletePaper(className, subject, examName, btn){
    if(!confirm(`Are you sure you want to delete ${subject} paper for ${className}?`)) return;

    const payload = {
        session: SESSION,
        class_name: className,
        exam_name: examName,
        subject
    };

    try{
        const res = await fetch(`${EXAM_API}/exam/delete-paper`, {
            method:"DELETE",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });
        const data = await res.json();
        alert(data.message);
        // remove the deleted paper from grid
        if(data.success) btn.parentElement.innerHTML = `<span style="color:red;">${subject} âŒ</span>`;
    } catch(e){
        console.error(e);
        alert("Failed to delete paper.");
    }
}
</script>
</body>
</html>


