<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Exam Roll No List - School ERP</title>

<style>
body { font-family:Poppins,sans-serif; background:#f2f4f7; margin:0; padding:0; display:flex; }
.sidebar {
    width:240px;
    background:#233465;
    color:white;
    height:100vh;
    position:fixed;
    left:0;
    top:0;
    padding-top:20px;
    box-sizing:border-box;
}
.sidebar h2 { text-align:center; font-size:22px; margin-bottom:25px; }
.sidebar a { display:block; padding:12px 20px; color:white; text-decoration:none; font-size:16px; }
.sidebar a:hover { background: rgba(255,255,255,0.25); }
.sidebar a.active { background: rgba(255,255,255,0.35); }

.container {
    margin-left:240px;
    flex:1;
    background:#fff;
    padding:20px;
    border-radius:10px;
    box-shadow:0 4px 12px rgba(0,0,0,0.08);
}
header { text-align:center; font-size:1.8rem; margin-bottom:10px; }
.info { text-align:center; margin-bottom:15px; font-size:1rem; }

table { width:100%; border-collapse:collapse; margin-top:10px; }
th, td { border:1px solid #ddd; padding:8px; text-align:center; }
th { background:#007bff; color:#fff; }
tr:nth-child(even){ background:#f9f9f9; }

button { margin-top:15px; padding:10px 15px; background:#4f46e5; color:#fff; border:none; border-radius:6px; cursor:pointer; }
button:hover { background:#3730a3; }

.roll-slips { display:none; }
.roll-slip { width:210mm; height:297mm; page-break-after:always; padding:20px; box-sizing:border-box; display:flex; flex-wrap:wrap; justify-content:space-between; }
.roll-slip .card { 
    width:32%; 
    height:53mm; /* Adjust to fit 4 rows per page */
    background:#f7f7f7; 
    padding:10px; 
    border-radius:6px; 
    box-sizing:border-box; 
    text-align:center; 
    font-size:13px; 
    border:2px solid #000; 
    margin-bottom:10px; 
    position:relative;
}
.roll-slip .card h4 { margin:0 0 4px 0; font-size:15px; }
.roll-slip .card img.logo { width:60px; height:auto; position:absolute; top:10px; right:10px; }

@media print {
    body { display:block; }
    .sidebar, button, select, label { display:none; }
    .roll-slip { page-break-after:always; }
}
</style>
</head>

<body>
<div class="sidebar">
    <h2>School ERP</h2>
    <a href="dashboard.html">Dashboard</a>
    <a href="exam_paper.html">Upload Papers</a>
    <a class="active" href="generate_rollno.html">Exam Roll No List</a>
    <a href="get_exam_paper.html">Uploaded Exam Papers</a>
</div>

<div class="container">
<header>Exam Roll No List</header>

<div class="info">
    <span id="schoolName">School: P.S. Public School</span>
</div>

<div>
<label>Session:</label>
<select id="sessionSelect"></select>

<label>Class:</label>
<select id="classSelect"></select>

<label>Exam:</label>
<select id="examSelect"></select>

<button onclick="generateList()">Generate List</button>
<button onclick="printSlips()">Print Roll No Slips</button>
</div>

<div style="overflow-x:auto; margin-top:20px;">
<table>
<thead>
<tr>
<th>School</th>
<th>Class</th>
<th>Roll No</th>
<th>Student Name</th>
<th>Father Name</th>
<th>Mother Name</th>
<th>Exam Name</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>

<div class="roll-slips" id="rollSlipsContainer"></div>
</div>

<script>
const STUDENT_API = "https://students-backend-8mup.onrender.com";
const EXAM_API = "https://exam-backend-ko0t.onrender.com";

let STUDENTS = [];
let EXAMS = [];

async function loadSessions() {
    const sessionSelect = document.getElementById("sessionSelect");
    sessionSelect.innerHTML = "<option>Loading sessions...</option>";

    try {
        const res = await fetch(`${EXAM_API}/session/list`);
        const data = await res.json();

        if(!data.success || !data.sessions || data.sessions.length === 0){
            sessionSelect.innerHTML = "<option>No sessions found</option>";
            return;
        }

        const sessions = data.sessions;
        let currentSession = localStorage.getItem("session") || sessions[0];

        sessionSelect.innerHTML = sessions.map(s=>`<option value="${s}">${s}</option>`).join("");
        sessionSelect.value = currentSession;

        // Save selection in localStorage
        sessionSelect.onchange = () => {
            currentSession = sessionSelect.value;
            localStorage.setItem("session", currentSession);
            loadStudents();
        };

        await loadStudents();

    } catch(e) {
        console.error("Error fetching sessions:", e);
        sessionSelect.innerHTML = "<option>Error loading sessions</option>";
    }
}

async function loadStudents() {
    const session = document.getElementById("sessionSelect").value;
    try {
        const res = await fetch(`${STUDENT_API}/students?session=${session}`);
        const data = await res.json();
        const studentsList = data.students || data || [];
        STUDENTS = studentsList;
        populateClasses();
        await loadExams();
    } catch(e) {
        console.error("Error fetching students:", e);
    }
}

function populateClasses() {
    const classes = [...new Set(STUDENTS.map(s => s.class_name).filter(Boolean))].sort();
    const classSelect = document.getElementById("classSelect");
    classSelect.innerHTML = `<option value="">Select</option>` + classes.map(c=>`<option value="${c}">${c}</option>`).join("");
    if(classes.length>0) classSelect.value = classes[0];
}

async function loadExams() {
    const session = document.getElementById("sessionSelect").value;
    try {
        const res = await fetch(`${EXAM_API}/exam/list-all?session=${session}`);
        const data = await res.json();
        EXAMS = data.exams || [];
        const examSelect = document.getElementById("examSelect");
        examSelect.innerHTML = `<option value="">Select</option>` + EXAMS.map(e=>`<option value="${e.exam_name}">${e.exam_name}</option>`).join("");
    } catch(e) {
        console.error("Error fetching exams:", e);
    }
}

function generateList() {
    const cls = document.getElementById("classSelect").value;
    const exam = document.getElementById("examSelect").value;
    const tbody = document.getElementById("tbody");
    tbody.innerHTML = "";

    if (!cls || !exam) return alert("Select class and exam");

    const filtered = STUDENTS.filter(s => s.class_name === cls);
    if(filtered.length === 0) return alert("No students found for this class");

    filtered.forEach(s => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>P.S. Public School</td>
            <td>${s.class_name || ""}</td>
            <td>${s.rollno || "N/A"}</td>
            <td>${s.student_name || "N/A"}</td>
            <td>${s.father_name || "N/A"}</td>
            <td>${s.mother_name || "N/A"}</td>
            <td>${exam}</td>
        `;
        tbody.appendChild(tr);
    });

    generateSlips(filtered, exam);
}

function generateSlips(students, examName){
    const container = document.getElementById("rollSlipsContainer");
    container.innerHTML = "";
    const perSheet = 12;

    for(let i=0; i<students.length; i+=perSheet){
        const slice = students.slice(i,i+perSheet);
        const div = document.createElement("div");
        div.classList.add("roll-slip");

        slice.forEach(s=>{
            const card = document.createElement("div");
            card.classList.add("card");
            card.innerHTML = `
                <img class="logo" src="images/logo1.png" alt="Logo" />
                <h4>${s.student_name || "N/A"}</h4>
                <p>P.S. Public School</p>
                <p>Class: ${s.class_name || ""}</p>
                <p>Roll No: ${s.rollno || "N/A"}</p>
                <p>Father: ${s.father_name || "N/A"}</p>
                <p>Mother: ${s.mother_name || "N/A"}</p>
                <p>Exam: ${examName}</p>
            `;
            div.appendChild(card);
        });

        container.appendChild(div);
    }

    container.style.display = "block";
}

function printSlips(){
    const printContents = document.getElementById("rollSlipsContainer").innerHTML;
    const originalContents = document.body.innerHTML;
    document.body.innerHTML = printContents;
    window.print();
    document.body.innerHTML = originalContents;
    window.location.reload();
}

// Reload students & exams when session changes
document.getElementById("sessionSelect").addEventListener("change", loadStudents);

// Load sessions on page load
loadSessions();
</script>
</body>
</html>





