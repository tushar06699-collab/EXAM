<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Exam Roll No List â€“ School ERP</title>

<style>
body { font-family:Poppins,sans-serif; background:#f2f4f7; margin:0; padding:0; display:flex; }
.sidebar {
    width:240px;
    background:#233465;
    color:white;
    height:100vh;
    position:fixed;
    left:0;
    top:0;
    padding-top:20px;
    box-sizing:border-box;
}
.sidebar h2 { text-align:center; font-size:22px; margin-bottom:25px; }
.sidebar a { display:block; padding:12px 20px; color:white; text-decoration:none; font-size:16px; }
.sidebar a:hover { background: rgba(255,255,255,0.25); }
.sidebar a.active { background: rgba(255,255,255,0.35); }

.container {
    margin-left:240px;
    flex:1;
    background:#fff;
    padding:20px;
    border-radius:10px;
    box-shadow:0 4px 12px rgba(0,0,0,0.08);
}
header { text-align:center; font-size:1.8rem; margin-bottom:10px; }

.info { text-align:center; margin-bottom:15px; font-size:1rem; }

table { width:100%; border-collapse:collapse; margin-top:10px; }
th, td { border:1px solid #ddd; padding:8px; text-align:center; }
th { background:#007bff; color:#fff; }
tr:nth-child(even){ background:#f9f9f9; }

button { margin-top:15px; padding:10px 15px; background:#4f46e5; color:#fff; border:none; border-radius:6px; cursor:pointer; }
button:hover { background:#3730a3; }

.roll-slips { display:none; }
.roll-slip { width:210mm; height:297mm; page-break-after:always; padding:20px; box-sizing:border-box; }
.roll-slip .row { display:flex; flex-wrap:wrap; gap:10px; }
.roll-slip .card { 
    flex: 1 1 calc(25% - 10px); 
    background:#f7f7f7; 
    padding:10px; 
    border-radius:6px; 
    margin-bottom:10px; 
    box-sizing:border-box; 
    text-align:center; 
    font-size:14px; 
    border:2px solid #000; 
    position:relative;
}
.roll-slip .card h4 { margin:0 0 5px 0; font-size:16px; }
.roll-slip .card img.logo { width:60px; height:auto; position:absolute; top:10px; right:10px; }
</style>
</head>

<body>
<div class="sidebar">
    <h2>School ERP</h2>
    <a href="dashboard.html">Dashboard</a>
    <a href="exam_paper.html">Upload Papers</a>
    <a class="active" href="generate_rollno.html">Exam Roll No List</a>
    <a href="get_exam_paper.html">Uploaded Exam Papers</a>
</div>

<div class="container">
<header>Exam Roll No List</header>

<div class="info">
    <span id="schoolName">School: P.S. Public School</span> | 
    <span id="inchargeName">Class Incharge: N/A</span>
</div>

<div>
<label>Session:</label>
<select id="sessionSelect"></select>

<label>Class:</label>
<select id="classSelect"></select>

<label>Exam:</label>
<select id="examSelect"></select>

<button onclick="generateList()">Generate List</button>
<button onclick="printSlips()">Print Roll No Slips</button>
</div>

<div style="overflow-x:auto; margin-top:20px;">
<table>
<thead>
<tr>
<th>School</th>
<th>Class</th>
<th>Roll No</th>
<th>Student Name</th>
<th>Father Name</th>
<th>Exam Name</th>
<th>Total Due</th>
<th>Class Incharge</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>

<div class="roll-slips" id="rollSlipsContainer"></div>
</div>

<script>
const FEE_API = "https://fee-backend-ntas.onrender.com";
const EXAM_API = "https://exam-backend-ko0t.onrender.com";

let STUDENTS = [];
let EXAMS = [];
let INCHARGE = {}; // cache for incharge

async function loadSessions() {
    const res = await fetch(`${FEE_API}/session/list`);
    const data = await res.json();
    const sessionSelect = document.getElementById("sessionSelect");
    sessionSelect.innerHTML = data.sessions.map(s => `<option value="${s}">${s}</option>`).join("");
    if(data.sessions.length > 0) sessionSelect.value = data.sessions[0];
    loadClasses();
}

async function loadClasses() {
    const session = document.getElementById("sessionSelect").value;
    const res = await fetch(`${FEE_API}/students`, { headers: { "X-Session": session }});
    const data = await res.json();
    STUDENTS = data.students || [];

    STUDENTS = STUDENTS.map(s => {
        try { s.months = typeof s.months === "string" ? JSON.parse(s.months) : s.months; } 
        catch(e){ s.months = {}; } 
        return s; 
    });

    const classes = [...new Set(STUDENTS.map(s=>s.class_name).filter(c=>c))].sort();
    const classSelect = document.getElementById("classSelect");
    classSelect.innerHTML = `<option value="">Select</option>` + classes.map(c=>`<option value="${c}">${c}</option>`).join("");
    if(classes.length>0) classSelect.value = classes[0];
    await loadExams();
    await loadIncharge(); // fetch incharge for session
}

async function loadExams() {
    const res = await fetch(`${EXAM_API}/exam/list-all`);
    const data = await res.json();
    EXAMS = data.exams || [];
    const examSelect = document.getElementById("examSelect");
    examSelect.innerHTML = `<option value="">Select</option>` + EXAMS.map(e=>`<option value="${e.exam_name}">${e.exam_name}</option>`).join("");
}

async function loadIncharge() {
    const session = document.getElementById("sessionSelect").value;
    const res = await fetch(`${EXAM_API}/incharge/get?session=${session}`);
    const data = await res.json();
    INCHARGE = data.success ? data.incharge : {};
    updateInchargeDisplay();
}

function updateInchargeDisplay() {
    const cls = document.getElementById("classSelect").value;
    const inchargeSpan = document.getElementById("inchargeName");
    inchargeSpan.textContent = "Class Incharge: " + (INCHARGE[cls] || "N/A");
}

async function generateList() {
    const cls = document.getElementById("classSelect").value;
    const exam = document.getElementById("examSelect").value;
    const tbody = document.getElementById("tbody");
    tbody.innerHTML = "";

    if(!cls || !exam) return alert("Select class and exam");

    const filtered = STUDENTS.filter(s => s.class_name === cls);

    if(filtered.length === 0) return alert("No students found for this class");

    filtered.forEach(s => {
        let prevDue = 0;
        if(s.months){
            const monthsObj = typeof s.months === "string" ? JSON.parse(s.months) : s.months;
            prevDue = monthsObj.previousDue ? Number(monthsObj.previousDue.due || 0) : Number(s.previous_due || 0);
        } else prevDue = Number(s.previous_due || 0);

        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>P.S. Public School</td>
            <td>${s.class_name || ""}</td>
            <td>${s.roll || "N/A"}</td>
            <td>${s.name || "N/A"}</td>
            <td>${s.father || "N/A"}</td>
            <td>${exam}</td>
            <td>${prevDue}</td>
            <td>${INCHARGE[cls] || "N/A"}</td>
        `;
        tbody.appendChild(tr);
    });

    generateSlips(filtered, exam);
}

function generateSlips(students, examName){
    const container = document.getElementById("rollSlipsContainer");
    container.innerHTML = "";
    const perSheet = 16;

    for(let i=0; i<students.length; i+=perSheet){
        const slice = students.slice(i, i+perSheet);
        const div = document.createElement("div");
        div.classList.add("roll-slip");
        const rowDiv = document.createElement("div");
        rowDiv.classList.add("row");

        slice.forEach(s=>{
            const card = document.createElement("div");
            card.classList.add("card");
            card.innerHTML = `
                <img    class="logo" src="images/logo1.png" alt="Logo" />
                <h4>${s.name || "N/A"}</h4>
                <p>P.S. Public School</p>
                <p>Class: ${s.class_name || ""}</p>
                <p>Roll No: ${s.roll || "N/A"}</p>
                <p>Father: ${s.father || "N/A"}</p>
                <p>Exam: ${examName}</p>
                <p>Class Incharge: ${INCHARGE[s.class_name] || "N/A"}</p>
            `;
            rowDiv.appendChild(card);
        });

        div.appendChild(rowDiv);
        container.appendChild(div);
    }

    container.style.display = "block";
}

function printSlips(){
    const printContents = document.getElementById("rollSlipsContainer").innerHTML;
    const originalContents = document.body.innerHTML;
    document.body.innerHTML = printContents;
    window.print();
    document.body.innerHTML = originalContents;
    window.location.reload();
}

document.getElementById("sessionSelect").addEventListener("change", loadClasses);
document.getElementById("classSelect").addEventListener("change", updateInchargeDisplay);
document.getElementById("classSelect").addEventListener("change", loadExams);

loadSessions();
</script>
</body>
</html>
