<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Class-wise Timetable - School ERP</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body { margin:0; font-family: Poppins, sans-serif; background:#f2f4f8; }

.sidebar {
    width:220px; height:100vh; background:#324a87; color:#fff;
    position:fixed; left:0; top:0; padding:20px;
}
.sidebar a { display:block; padding:12px; margin:5px 0; color:#fff; text-decoration:none; border-radius:8px; }
.sidebar a:hover, .sidebar a.active { background:#233465; }

.main { margin-left:240px; padding:30px; }
h1 { text-align:center; margin-bottom:20px; }

.top-bar { display:flex; justify-content:center; gap:20px; margin-bottom:20px; }
label { font-weight:600; }
select { padding:5px; border-radius:5px; }
button{
    padding:6px 12px;
    border:none;
    border-radius:6px;
    background:#1e8f3d;
    color:#fff;
    cursor:pointer;
}

table {
    width:100%; border-collapse: collapse; background:white;
    border-radius:10px; overflow:hidden; box-shadow:0 3px 10px rgba(0,0,0,0.1);
    text-align:center;
}
th, td { padding:10px; border:1px solid #ddd; }
th { background:#324a87; color:white; }
tr:nth-child(even){ background:#f2f4f7; }
.lunch-cell { background:#f0f0f0; font-weight:bold; }

.timetable-cell { display:flex; flex-direction:column; gap:2px; font-size:13px; }
.timetable-cell span { display:block; }
.status-note{margin:8px 0 14px;text-align:center;font-size:13px;color:#233465;font-weight:600}
</style>
</head>

<body>

<div class="sidebar">
    <h2>EXAM ERP</h2>
    <a href="dashboard.html">Dashboard</a>
    <a href="subject_add.html">Subjects Management</a>
    <a href="exam_subject_marks_config.html">Subject Marks Config</a>
    <a href="teachers.html">Teacher Management</a>
    <a href="Timetable.html">Add Timetable</a>
    <a href="get_classes_timetable.html" class="active">View Class Timetable</a>
    <a href="get_teacher_timetable.html">View Teacher Timetable</a>    
</div>

<div class="main">
    <h1>Class-wise Timetable</h1>

    <div class="top-bar">
        <div>
            <label>Session:</label>
            <select id="sessionSelect"></select>
        </div>
        <div>
            <label>&nbsp;</label>
            <button onclick="autoAssignIncharge()">Auto Assign Incharge (Period 1)</button>
        </div>
        <div>
            <label>&nbsp;</label>
            <button onclick="downloadPDF()">Download PDF</button>
        </div>
    </div>
    <div id="statusNote" class="status-note"></div>

    <table>
        <thead>
            <tr id="theadRow"><th>Class</th></tr>
        </thead>
        <tbody id="timetableBody"></tbody>
    </table>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
const EXAM_API = "https://exam-backend-117372286918.asia-south1.run.app/";

const periods = ["Period 1","Period 2","Period 3","Period 4","Lunch","Period 5","Period 6","Period 7","Period 8"];

const periodMap = {
    "Period 1": 1,
    "Period 2": 2,
    "Period 3": 3,
    "Period 4": 4,
    "Period 5": 5,
    "Period 6": 6,
    "Period 7": 7,
    "Period 8": 8
};

const weekDays = ["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];

const sessionSelect = document.getElementById("sessionSelect");
const theadRow = document.getElementById("theadRow");
const timetableBody = document.getElementById("timetableBody");
const statusNote = document.getElementById("statusNote");

let classes = [];
let timetableData = {};

function normalizeClassName(raw){
    return String(raw || "").trim().replace(/\s+/g, " ");
}

function normalizeSessionList(raw){
    const arr = Array.isArray(raw) ? raw : [];
    return arr.map(s => {
        if (typeof s === "string") return s;
        if (s && typeof s === "object") return String(s.name || s.session || "").trim();
        return "";
    }).filter(Boolean);
}

function pickTeacherFromPeriod1Rows(rows){
    if (!Array.isArray(rows) || !rows.length) return "";
    for (const row of rows) {
        for (const d of weekDays) {
            const v = String(row?.[d] || "").trim();
            if (!v || !v.includes(" - ")) continue;
            const teacher = String(v.split(" - ")[0] || "").trim();
            if (teacher) return teacher;
        }
    }
    return "";
}

// LOAD SESSIONS
async function loadSessions() {
    const res = await fetch(`${EXAM_API}/session/list`);
    const data = await res.json();
    const sessions = normalizeSessionList(data.sessions);
    sessionSelect.innerHTML = sessions.map(s=>`<option value="${s}">${s}</option>`).join("");
}

// LOAD CLASSES
const STUDENT_API = "https://student-backend-117372286918.asia-south1.run.app/";

// LOAD CLASSES
async function loadClasses() {
    try {
        const session = sessionSelect.value;
        const res = await fetch(`${STUDENT_API}/students?session=${encodeURIComponent(session)}`);
        const data = await res.json();

        // Support both array directly or object with 'students' property
        const studentList = Array.isArray(data) ? data : (data.students || []);

        // Extract unique class names
        classes = [...new Set(studentList.map(s => s.class_name).filter(Boolean))];

        // Custom sort: numeric first, then stream
        classes.sort((a,b)=>{
            const regex = /^(\d+)(?:\s*(.*))?$/;
            const ma = a.match(regex), mb = b.match(regex);
            if(!ma || !mb) return 0;
            const numA = parseInt(ma[1]), numB = parseInt(mb[1]);
            if(numA !== numB) return numA - numB;
            const streamA = ma[2]||"", streamB = mb[2]||"";
            return streamA.localeCompare(streamB);
        });

        console.log("Classes loaded:", classes);

    } catch(e) {
        console.error("Error loading classes:", e);
        classes = [];
    }
}

// LOAD TIMETABLE
async function loadTimetable() {
    const session = sessionSelect.value;

    timetableData = {};
    const jobs = classes.map(async (cls)=>{
        try{
            const res = await fetch(`${EXAM_API}/timetable/classwise?session=${encodeURIComponent(session)}&class_name=${encodeURIComponent(cls)}`);
            const data = await res.json();
            timetableData[cls] = data.timetable || [];
        } catch {
            timetableData[cls] = [];
        }
    });
    await Promise.all(jobs);
}

async function autoAssignIncharge(){
    const session = sessionSelect.value;
    if (!session) {
        alert("Select session first");
        return;
    }
    if (!classes.length) {
        alert("No classes loaded");
        return;
    }

    statusNote.textContent = "Assigning incharge from Period 1...";

    let success = 0;
    let skipped = 0;
    let failed = 0;

    for (const cls of classes) {
        const rows = Array.isArray(timetableData[cls]) ? timetableData[cls] : [];
        const period1Rows = rows.filter(item => Number(item.period) === 1);
        const teacher = pickTeacherFromPeriod1Rows(period1Rows);
        if (!teacher) {
            skipped += 1;
            continue;
        }

        // Save against normalized class key so class_list page can show it reliably.
        const classKey = normalizeClassName(cls);
        try{
            const res = await fetch(`${EXAM_API}/incharge/set`, {
                method: "POST",
                headers: { "Content-Type":"application/json" },
                body: JSON.stringify({
                    session,
                    class_name: classKey,
                    incharge: teacher
                })
            });
            const data = await res.json().catch(() => ({}));
            if (res.ok && data?.success !== false) success += 1;
            else failed += 1;
        }catch(_){
            failed += 1;
        }
    }

    statusNote.textContent = `Auto-assign complete: Saved ${success}, Skipped ${skipped}, Failed ${failed}`;
}

// RENDER TABLE
function renderTable() {

    theadRow.innerHTML = "<th>Class</th>" + periods.map(p => `<th>${p}</th>`).join("");
    const rows = [];

    for (let cls of classes) {

        let rowHTML = `<tr><td><strong>${cls}</strong></td>`;

        for (let p of periods) {

            if (p === "Lunch") {
                rowHTML += `<td class="lunch-cell">Lunch</td>`;
                continue;
            }

            const periodNumber = periodMap[p];

            // FIX: get ALL records for this period
            const cells = timetableData[cls].filter(item => Number(item.period) === periodNumber);

            if (!cells.length) {
                rowHTML += `<td></td>`;
                continue;
            }

            let cellHTML = "";

            cells.forEach(cell => {
                let teacher = "";
                let subject = "";
                let days = [];

                weekDays.forEach(day => {
                    if (cell[day] && cell[day].includes(" - ")) {
                        const [t, s] = cell[day].split(" - ");
                        teacher = t;
                        subject = s;
                        days.push(day.slice(0, 3));
                    }
                });

                cellHTML += `
                    <div class="timetable-cell">
                        <span><strong>${teacher}</strong></span>
                        <span>${subject}</span>
                        <span>${days.join(",")}</span>
                    </div>
                    <hr>
                `;
            });

            rowHTML += `<td>${cellHTML}</td>`;
        }

        rowHTML += "</tr>";
        rows.push(rowHTML);
    }
    timetableBody.innerHTML = rows.join("");
}

async function downloadPDF(){
    const table = document.querySelector(".main table");
    if(!table) return alert("No timetable to export.");
    const jsPDFCtor = window.jspdf && window.jspdf.jsPDF;
    if(!jsPDFCtor || typeof window.html2canvas === "undefined"){
        return alert("PDF library not loaded. Refresh and try again.");
    }

    const host = document.createElement("div");
    host.style.position = "fixed";
    host.style.left = "-99999px";
    host.style.top = "0";
    host.style.width = "1600px";
    host.style.background = "#fff";
    host.style.padding = "10px";
    host.innerHTML = `<h3 style="margin:0 0 10px 0;font-family:Poppins,sans-serif;">Class-wise Timetable (${sessionSelect.value})</h3>`;
    host.appendChild(table.cloneNode(true));
    document.body.appendChild(host);

    try{
        const canvas = await window.html2canvas(host, {scale:2, useCORS:true, backgroundColor:"#fff"});
        const img = canvas.toDataURL("image/jpeg", 0.95);
        const pdf = new jsPDFCtor("l","mm","a4");
        const pageW=297,pageH=210,margin=6,maxW=pageW-margin*2,maxH=pageH-margin*2;
        let w=maxW,h=(canvas.height*w)/canvas.width;
        if(h<=maxH){
            const x=(pageW-w)/2,y=(pageH-h)/2;
            pdf.addImage(img,"JPEG",x,y,w,h);
        }else{
            const pageCanvas=document.createElement("canvas");
            const ctx=pageCanvas.getContext("2d");
            const sliceHeightPx=Math.floor(canvas.width*(maxH/maxW));
            pageCanvas.width=canvas.width;
            let yPx=0,page=0;
            while(yPx<canvas.height){
                const cur=Math.min(sliceHeightPx, canvas.height-yPx);
                pageCanvas.height=cur;
                ctx.clearRect(0,0,pageCanvas.width,pageCanvas.height);
                ctx.drawImage(canvas,0,yPx,canvas.width,cur,0,0,canvas.width,cur);
                const slice=pageCanvas.toDataURL("image/jpeg",0.95);
                const sliceH=(cur*maxW)/canvas.width;
                if(page>0) pdf.addPage();
                pdf.addImage(slice,"JPEG",margin,margin,maxW,sliceH);
                yPx+=cur; page+=1;
            }
        }
        pdf.save(`class_timetable_${sessionSelect.value}.pdf`);
    }catch(e){
        console.error(e);
        alert("Unable to generate PDF.");
    }finally{
        if(host.parentNode) host.parentNode.removeChild(host);
    }
}

// INIT
async function init() {
    await loadSessions();
    await loadClasses();

    sessionSelect.onchange = async () => {
        await loadClasses();
        await loadTimetable();
        renderTable();
    };

    await loadTimetable();
    renderTable();
}

init();
</script>

</body>
</html>





