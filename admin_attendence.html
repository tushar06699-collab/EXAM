<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Attendance Upload – School ERP</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{margin:0;font-family:Poppins,sans-serif;background:#f2f4f7;display:flex;}
.sidebar{width:240px;background:#233465;color:white;height:100vh;position:fixed;left:0;top:0;padding-top:20px;}
.sidebar h2{text-align:center;font-size:22px;margin-bottom:25px;}
.sidebar a{display:block;padding:12px 20px;color:white;text-decoration:none;font-size:16px;}
.sidebar a:hover{background:rgba(255,255,255,0.25);}
.content{margin-left:240px;width:calc(100% - 240px);padding:20px;}
header{background:#233465;color:#fff;padding:1rem;text-align:center;font-size:1.5rem;border-radius:8px;}
main{max-width:700px;margin:2rem auto;background:#fff;padding:2rem;border-radius:12px;box-shadow:0 2px 12px rgba(0,0,0,0.1);}
label{display:block;font-weight:600;margin-top:15px;}
select,input{width:100%;padding:10px;margin-top:5px;border:1px solid #ccc;border-radius:6px;}
button{margin-top:20px;width:100%;padding:12px;background:#4f46e5;color:white;border:none;font-size:16px;border-radius:6px;cursor:pointer;}
button:hover{background:#3730a3;}
table{width:100%;border-collapse:collapse;margin-top:20px;}
th,td{border:1px solid #ccc;padding:8px;text-align:center;}
th{background:#233465;color:white;}
.attendance-select{width:100px;}
</style>
</head>

<body>

<div class="sidebar">
<h2>School ERP</h2>
<a href="dashboard.html">Dashboard</a>
<a href="admin_attendence.html" style="background:rgba(255,255,255,0.2);">Attendance Upload</a>
<a href="view_attendence.html">Monthly Attendance</a>
</div>

<div class="content">
<header>Upload Attendance</header>

<main>
<label>Session</label>
<select id="sessionSelect"></select>

<label>Class</label>
<select id="classSelect"></select>

<label>Date</label>
<input type="date" id="attendanceDate">

<button onclick="loadStudents()">Load Students</button>

<div id="tableContainer"></div>

<button onclick="uploadAttendance()" style="background:#1e8f3d;">Save Attendance</button>
</main>
</div>

<script>
const STUDENT_API = "https://students-backend-8mup.onrender.com";
const ATTENDANCE_API = "https://exam-backend-ko0t.onrender.com";

const sessionSelect = document.getElementById("sessionSelect");
const classSelect = document.getElementById("classSelect");
const attendanceDate = document.getElementById("attendanceDate");

/* -----------------------------
   AUTO LOAD TODAY DATE
----------------------------- */
window.addEventListener("DOMContentLoaded", () => {
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, "0");
    const dd = String(today.getDate()).padStart(2, "0");

    const formattedDate = `${yyyy}-${mm}-${dd}`;
    attendanceDate.value = formattedDate;
    attendanceDate.max = formattedDate; // prevent future date
});

/* -----------------------------
   LOAD SESSIONS
----------------------------- */
async function loadSessions(){
    const res = await fetch(`${ATTENDANCE_API}/session/list`);
    const data = await res.json();

    sessionSelect.innerHTML = `<option value="">Select Session</option>`;
    if(data.sessions){
        data.sessions.forEach(s=>{
            sessionSelect.innerHTML += `<option value="${s}">${s}</option>`;
        });
        sessionSelect.value = data.sessions[0];
        loadClasses();
    }
}
loadSessions();

sessionSelect.addEventListener("change", loadClasses);

/* -----------------------------
   LOAD CLASSES
----------------------------- */
async function loadClasses(){
    const session = sessionSelect.value;
    if(!session) return;

    const res = await fetch(`${STUDENT_API}/students?session=${session}`);
    const students = await res.json();

    const classes = [...new Set(students.map(s=>s.class_name).filter(Boolean))];
    classSelect.innerHTML = `<option value="">Select Class</option>`;
    classes.forEach(c=>{
        classSelect.innerHTML += `<option value="${c}">${c}</option>`;
    });
}

/* -----------------------------
   LOAD STUDENTS
----------------------------- */
async function loadStudents(){
    const session = sessionSelect.value;
    const cls = classSelect.value;
    const date = attendanceDate.value;

    if(!session || !cls || !date){
        alert("Select session, class, and date");
        return;
    }

    const res = await fetch(`${STUDENT_API}/students?session=${session}`);
    const students = await res.json();
const classStudents = students
    .filter(s => s.class_name === cls)
    .sort((a, b) => {
        const ra = parseInt(a.rollno) || 0;
        const rb = parseInt(b.rollno) || 0;
        return ra - rb;
    });

    if(!classStudents.length){
        alert("No students found");
        return;
    }

    let existingAttendance = {};
    try{
        const attRes = await fetch(
            `${ATTENDANCE_API}/attendance/list?session=${session}&class_name=${encodeURIComponent(cls)}&date=${date}`
        );
        const attData = await attRes.json();
        if(attData.success){
            attData.attendance.forEach(a=>{
                existingAttendance[a.student_id] = a.status;
            });
        }
    }catch(e){}

    let html = `<table>
        <tr><th>Roll No</th><th>Name</th><th>Attendance</th></tr>`;

    classStudents.forEach(s=>{
        const status = existingAttendance[s._id] || "present";
        html += `
        <tr>
            <td>${s.rollno}</td>
            <td>${s.student_name}</td>
            <td>
<select class="attendance-select" data-student-id="${s._id}">
                    <option value="present" ${status==="present"?"selected":""}>Present</option>
                    <option value="absent" ${status==="absent"?"selected":""}>Absent</option>
                    <option value="leave" ${status==="leave"?"selected":""}>Leave</option>
                </select>
            </td>
        </tr>`;
    });

    html += `</table>`;
    document.getElementById("tableContainer").innerHTML = html;
}

/* -----------------------------
   SAVE ATTENDANCE
----------------------------- */
async function uploadAttendance(){
    const session = sessionSelect.value;
    const class_name = classSelect.value;
    const date = attendanceDate.value;

    if(!session || !class_name || !date){
        alert("Select session, class, and date");
        return;
    }

    const attendance = [...document.querySelectorAll(".attendance-select")].map(s=>({
        student_id: s.dataset.studentId,
        status: s.value
    }));

    const res = await fetch(`${ATTENDANCE_API}/attendance/save`,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({session,class_name,date,attendance})
    });

    const data = await res.json();
    if(data.success) alert("✅ Attendance saved successfully");
    else alert("❌ " + data.message);
}
</script>

</body>
</html>
