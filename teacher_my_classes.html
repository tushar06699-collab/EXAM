<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>My Timetable - Teacher</title>
<meta name="viewport" content="width=device-width">
<style>
body{
    margin:0;
    font-family:Poppins, sans-serif;
    background:#eef1f6;
}

/* ---------------- TOPBAR ---------------- */
.topbar {
    background:#233465;
    color:white;
    padding:18px 20px;
    display:flex;
    justify-content:flex-start;
    align-items:center;
    gap:20px;
}
.topbar h2{
    margin:0;
    font-size:22px;
}

/* Hamburger Icon */
.menu-icon{
    font-size:26px;
    cursor:pointer;
    user-select:none;
}

/* ---------------- SLIDING SIDEBAR ---------------- */
.sidebar{
    width:250px;
    height:100vh;
    background:#233465;
    color:white;
    position:fixed;
    top:0;
    left:-260px;
    transition:0.3s ease;
    padding-top:20px;
    z-index:1000;
}
.sidebar.active{
    left:0;
}
.sidebar h2{
    text-align:center;
    margin-bottom:20px;
}
.sidebar a{
    display:block;
    padding:12px 20px;
    color:white;
    text-decoration:none;
    font-size:16px;
}
.sidebar a:hover{
    background:rgba(255,255,255,0.25);
}

/* Close Button */
.close-btn{
    font-size:28px;
    color:white;
    position:absolute;
    top:10px;
    right:15px;
    cursor:pointer;
}

/* Overlay */
.overlay{
    position:fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    background:rgba(0,0,0,0.4);
    display:none;
    z-index:999;
}
.overlay.active{
    display:block;
}

/* ---------------- MAIN CONTENT ---------------- */
.container{
    width:95%;
    max-width:1000px;
    margin:30px auto;
}
.card{
    background:white;
    padding:22px;
    border-radius:12px;
    box-shadow:0 4px 12px rgba(0,0,0,0.1);
    margin-bottom:20px;
}

table{
    width:100%;
    border-collapse:collapse;
    text-align:center;
}
th,td{
    padding:12px;
    border:1px solid #ddd;
    vertical-align:top;
}
th{
    background:#f1f3fa;
}
.lunch-cell{
    background:#f0f0f0;
    font-weight:bold;
}
.timetable-cell{
    display:flex;
    flex-direction:column;
    gap:2px;
    font-size:13px;
}
.timetable-cell span{ display:block; }

.back-btn{
    background:#324a87;
    padding:10px 18px;
    border-radius:8px;
    color:white;
    text-decoration:none;
}

</style>
</head>

<body>

<!-- SIDEBAR -->
<div class="sidebar" id="sidebar">
    <span class="close-btn" onclick="closeMenu()">×</span>
    <h2>Teacher Menu</h2>
    <a href="teacher_dashboard.html">Dashboard</a>
    <a href="teacher_my_classes.html" style="background: rgba(255,255,255,0.25);">My Time Table</a>
    <a href="teacher_view_datesheet.html">View Datesheet</a>
    <a href="teacher_papers.html">Question Papers</a>
    <a href="teacher_marks_upload.html">Upload Marks</a>
</div>

<!-- OVERLAY -->
<div class="overlay" id="overlay" onclick="closeMenu()"></div>

<!-- TOPBAR -->
<div class="topbar">
    <span class="menu-icon" onclick="openMenu()">☰</span>
    <h2>My Timetable</h2>
</div>

<div class="container">
    <div class="card">
        <h3>Timetable for <span id="teacherNameDisplay"></span></h3>

        <label>Session: </label>
        <select id="sessionSelect"></select>

        <table>
            <thead>
                <tr id="theadRow">
                    <th>Period</th>
                    <th>Monday</th>
                    <th>Tuesday</th>
                    <th>Wednesday</th>
                    <th>Thursday</th>
                    <th>Friday</th>
                    <th>Saturday</th>
                </tr>
            </thead>
            <tbody id="timetableBody"></tbody>
        </table>
    </div>
</div>

<script>
const EXAM_API = "http://127.0.0.1:5000";
const FEE_API = "https://fee-backend-ntas.onrender.com";

const periods = ["Period 1","Period 2","Period 3","Period 4","Lunch","Period 5","Period 6","Period 7","Period 8"];
const periodMap = {"Period 1":1,"Period 2":2,"Period 3":3,"Period 4":4,"Period 5":5,"Period 6":6,"Period 7":7,"Period 8":8};
const weekDays = ["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];

let teacherName = localStorage.getItem("teacher_name");
let teacherSession = localStorage.getItem("session");

if(!teacherName){
    alert("Login expired! Please login again.");
    window.location.href = "login.html";
}

document.getElementById("teacherNameDisplay").textContent = teacherName;

const sessionSelect = document.getElementById("sessionSelect");
const timetableBody = document.getElementById("timetableBody");

let classes = [];
let timetableData = {};


// ---------------- SLIDER MENU FUNCTIONS ---------------- //
function openMenu(){
    document.getElementById("sidebar").classList.add("active");
    document.getElementById("overlay").classList.add("active");
}
function closeMenu(){
    document.getElementById("sidebar").classList.remove("active");
    document.getElementById("overlay").classList.remove("active");
}



// Load sessions
async function loadSessions() {
    const res = await fetch(`${FEE_API}/session/list`);
    const data = await res.json();
    sessionSelect.innerHTML = data.sessions.map(s=>`<option value="${s}">${s}</option>`).join("");
}

// Load all classes
async function loadClasses() {
    const res = await fetch(`${FEE_API}/students`);
    const data = await res.json();
    classes = [...new Set(data.students.map(s => s.class_name))].sort();
}

// Load timetable
async function loadTimetable() {
    const session = sessionSelect.value;
    timetableData = {};

    for(let cls of classes){
        try{
            const res = await fetch(`${EXAM_API}/timetable/classwise?session=${session}&class_name=${encodeURIComponent(cls)}`);
            const data = await res.json();
            timetableData[cls] = data.timetable || [];
        }catch{
            timetableData[cls] = [];
        }
    }
}

// Render timetable
function renderTable() {
    timetableBody.innerHTML = "";
    
    for(let p of periods){
        let rowHTML = `<tr><td>${p}</td>`;
        if(p === "Lunch"){
            rowHTML += `<td colspan="6" class="lunch-cell">Lunch</td></tr>`;
            timetableBody.innerHTML += rowHTML;
            continue;
        }

        weekDays.forEach(day=>{
            let cellHTML = "";
            classes.forEach(cls=>{
                const items = timetableData[cls].filter(item => Number(item.period) === periodMap[p]);
                items.forEach(item=>{
                    if(item[day] && item[day].startsWith(teacherName + " - ")){
                        const subject = item[day].split(" - ")[1];
                        cellHTML += `
                            <div class="timetable-cell">
                                <span>${subject}</span>
                                <span>Class: ${cls}</span>
                            </div>
                        `;
                    }
                });
            });
            rowHTML += `<td>${cellHTML}</td>`;
        });

        rowHTML += "</tr>";
        timetableBody.innerHTML += rowHTML;
    }
}

// INIT
async function init(){
    await loadSessions();
    await loadClasses();

    sessionSelect.value = teacherSession;

    sessionSelect.onchange = async ()=>{
        teacherSession = sessionSelect.value;
        await loadTimetable();
        renderTable();
    };

    await loadTimetable();
    renderTable();
}

init();

</script>

</body>
</html>
