<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Monthly Attendance - School ERP</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{margin:0;font-family:Poppins,sans-serif;background:#f2f4f7;display:flex;}
.sidebar{width:240px;background:#233465;color:white;height:100vh;position:fixed;left:0;top:0;padding-top:20px;}
.sidebar h2{text-align:center;font-size:22px;margin-bottom:25px;}
.sidebar a{display:block;padding:12px 20px;color:white;text-decoration:none;font-size:16px;}
.sidebar a:hover{background:rgba(255,255,255,0.25);}
.content{margin-left:240px;width:calc(100% - 240px);padding:20px;}
header{background:#233465;color:#fff;padding:1rem;text-align:center;font-size:1.5rem;border-radius:8px;}
main{max-width:900px;margin:2rem auto;background:#fff;padding:2rem;border-radius:12px;box-shadow:0 2px 12px rgba(0,0,0,0.1);}
label{display:block;font-weight:600;margin-top:15px;}
select,input{width:100%;padding:10px;margin-top:5px;border:1px solid #ccc;border-radius:6px;}
button{margin-top:20px;width:100%;padding:12px;background:#4f46e5;color:white;border:none;font-size:16px;border-radius:6px;cursor:pointer;}
button:hover{background:#3730a3;}
table{width:100%;border-collapse:collapse;margin-top:20px;}
th,td{border:1px solid #ccc;padding:8px;text-align:center;font-size:13px;}
th{background:#233465;color:white;}
.export-btn{background:#f59e0b;margin-top:10px;}
</style>
</head>

<body>

<div class="sidebar">
<h2>School ERP</h2>
<a href="dashboard.html">Dashboard</a>
<a href="admin_attendence.html">Attendance Upload</a>
<a href="view_attendence.html" style="background:rgba(255,255,255,0.25);">Monthly Attendance</a>
</div>

<div class="content">
<header>Monthly Attendance</header>

<main>
<label>Session</label>
<select id="sessionSelect"></select>

<label>Class</label>
<select id="classSelect"></select>

<label>Month</label>
<input type="month" id="monthSelect">

<button onclick="loadAttendance()">Load Attendance</button>

<div id="tableContainer"></div>
<button onclick="exportCSV()" class="export-btn">Export CSV</button>
<button onclick="exportPDF()" class="export-btn">Export PDF</button>
</main>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script>
const STUDENT_API = "https://student-backend-117372286918.asia-south1.run.app/";
const ATTENDANCE_API = "https://exam-backend-117372286918.asia-south1.run.app/";

const sessionSelect = document.getElementById("sessionSelect");
const classSelect = document.getElementById("classSelect");
const monthSelect = document.getElementById("monthSelect");

/* ================= AUTO MONTH ================= */
window.addEventListener("DOMContentLoaded", () => {
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    monthSelect.value = `${y}-${m}`;
    monthSelect.max = `${y}-${m}`;
});

/* ================= LOAD SESSIONS ================= */
async function loadSessions(){
    const res = await fetch(`${ATTENDANCE_API}/session/list`);
    const data = await res.json();

    sessionSelect.innerHTML = `<option value="">Select Session</option>`;
    if(data.sessions){
        data.sessions.forEach(s=>{
            sessionSelect.innerHTML += `<option value="${s}">${s}</option>`;
        });
        sessionSelect.value = data.sessions[0];
        loadClasses();
    }
}
loadSessions();
sessionSelect.addEventListener("change", loadClasses);

/* ================= LOAD CLASSES ================= */
async function loadClasses(){
    const session = sessionSelect.value;
    if(!session) return;

    const res = await fetch(`${STUDENT_API}/students?session=${session}`);
    const raw = await res.json();
    const students = Array.isArray(raw) ? raw : raw.students || [];

    const classes = [...new Set(students.map(s=>s.class_name).filter(Boolean))];
    classSelect.innerHTML = `<option value="">Select Class</option>` +
        classes.map(c=>`<option value="${c}">${c}</option>`).join("");
}

/* ================= LOAD ATTENDANCE ================= */
async function loadAttendance(){
    const session = sessionSelect.value;
    const cls = classSelect.value;
    const month = monthSelect.value;

    if(!session || !cls || !month){
        alert("Select session, class and month");
        return;
    }

    const [year, mon] = month.split("-");
    const daysInMonth = new Date(year, mon, 0).getDate();

    const sr = await fetch(`${STUDENT_API}/students?session=${session}`);
    const rawStudents = await sr.json();
    const students = Array.isArray(rawStudents) ? rawStudents : rawStudents.students || [];
const classStudents = students
    .filter(s => s.class_name === cls)
    .sort((a, b) => {
        const ra = parseInt(a.rollno) || 0;
        const rb = parseInt(b.rollno) || 0;
        return ra - rb;
    });

    if(!classStudents.length){
        alert("No students found");
        return;
    }

    let attendanceMap = {};

    classStudents.forEach(s=>{
const sid = (typeof s._id === "string") ? s._id : (s._id && s._id.$oid ? s._id.$oid : (s.id || s.student_id || ""));
        attendanceMap[sid] = {
            name: s.student_name,
            roll: s.rollno || "-"
        };
        for(let d=1; d<=daysInMonth; d++){
            attendanceMap[sid][`${year}-${mon}-${String(d).padStart(2,"0")}`] = "-";
        }
    });

    for(let d=1; d<=daysInMonth; d++){
        const dateStr = `${year}-${mon}-${String(d).padStart(2,"0")}`;
        try{
            const ar = await fetch(
                `${ATTENDANCE_API}/attendance/list?session=${session}&class_name=${encodeURIComponent(cls)}&date=${dateStr}`
            );
            const ad = await ar.json();
            if(ad.success){
                ad.attendance.forEach(a=>{
                    if(attendanceMap[a.student_id]){
                        attendanceMap[a.student_id][dateStr] = a.status;
                    }
                });
            }
        }catch(e){}
    }

    let html = `<table><tr><th>Roll</th><th>Name</th>`;
    for(let d=1; d<=daysInMonth; d++) html += `<th>${d}</th>`;
    html += `<th>P</th><th>A</th><th>L</th></tr>`;

    Object.values(attendanceMap).forEach(info=>{
        let p=0,a=0,l=0;
        html += `<tr><td>${info.roll}</td><td>${info.name}</td>`;
        for(let d=1; d<=daysInMonth; d++){
            const st = info[`${year}-${mon}-${String(d).padStart(2,"0")}`];

let display = "-";
let cellStyle = "";
if(st === "present"){
    display = "P";
    p++;
}
else if(st === "absent"){
    display = "A";
    cellStyle = 'style="background:#ef4444;color:#ffffff;font-weight:700"';
    a++;
}
else if(st === "leave"){
    display = "L";
    cellStyle = 'style="background:#facc15;color:#111827;font-weight:700"';
    l++;
}

html += `<td ${cellStyle}>${display}</td>`;

        }
        html += `<td>${p}</td><td>${a}</td><td>${l}</td></tr>`;
    });

    html += `</table>`;
    document.getElementById("tableContainer").innerHTML = html;
}

/* ================= EXPORT CSV ================= */
function exportCSV(){
    const table = document.querySelector("#tableContainer table");
    if(!table) return alert("No data");

    let csv = [];
    table.querySelectorAll("tr").forEach(tr=>{
        csv.push([...tr.children].map(td=>td.innerText).join(","));
    });

    const blob = new Blob([csv.join("\n")],{type:"text/csv"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `attendance_${monthSelect.value}.csv`;
    a.click();
    URL.revokeObjectURL(a.href);
}

async function exportPDF(){
    const table = document.querySelector("#tableContainer table");
    if(!table) return alert("No data");

    const jsPDFCtor = window.jspdf && window.jspdf.jsPDF;
    if(!jsPDFCtor || typeof window.html2canvas === "undefined"){
        return alert("PDF library is not loaded. Please refresh and try again.");
    }

    const host = document.createElement("div");
    host.style.position = "fixed";
    host.style.left = "-99999px";
    host.style.top = "0";
    host.style.background = "#fff";
    host.style.padding = "10px";
    host.style.width = "2200px";
    host.style.fontFamily = "Poppins, sans-serif";
    host.style.fontSize = "11px";

    const title = document.createElement("h3");
    title.textContent = `Attendance Report - ${classSelect.value} - ${monthSelect.value}`;
    title.style.margin = "0 0 10px 0";
    title.style.fontFamily = "Poppins, sans-serif";
    title.style.fontSize = "14px";
    host.appendChild(title);
    const tableClone = table.cloneNode(true);
    tableClone.style.fontSize = "10px";
    tableClone.querySelectorAll("th,td").forEach(cell=>{
        cell.style.padding = "4px";
        cell.style.fontSize = "10px";
        cell.style.whiteSpace = "nowrap";
    });
    host.appendChild(tableClone);
    document.body.appendChild(host);

    const btn = document.querySelector('button[onclick="exportPDF()"]');
    const oldLabel = btn ? btn.textContent : "";
    if(btn) btn.textContent = "Generating PDF...";

    try{
        const canvas = await window.html2canvas(host, {
            scale: 2,
            useCORS: true,
            allowTaint: true,
            backgroundColor: "#ffffff"
        });

        const imgData = canvas.toDataURL("image/jpeg", 0.95);
        const pdf = new jsPDFCtor("l", "mm", "a4");

        const pageW = 297;
        const pageH = 210;
        const margin = 6;
        const maxW = pageW - margin * 2;
        const maxH = pageH - margin * 2;

        let imgW = maxW;
        let imgH = (canvas.height * imgW) / canvas.width;
        if(imgH <= maxH){
            const x = (pageW - imgW) / 2;
            const y = (pageH - imgH) / 2;
            pdf.addImage(imgData, "JPEG", x, y, imgW, imgH);
        }else{
            // Multi-page split for tall reports
            const pageCanvas = document.createElement("canvas");
            const ctx = pageCanvas.getContext("2d");
            const sliceHeightPx = Math.floor(canvas.width * (maxH / maxW));
            pageCanvas.width = canvas.width;

            let yPx = 0;
            let page = 0;
            while(yPx < canvas.height){
                const currentSlice = Math.min(sliceHeightPx, canvas.height - yPx);
                pageCanvas.height = currentSlice;
                ctx.clearRect(0,0,pageCanvas.width,pageCanvas.height);
                ctx.drawImage(canvas, 0, yPx, canvas.width, currentSlice, 0, 0, canvas.width, currentSlice);

                const sliceData = pageCanvas.toDataURL("image/jpeg", 0.95);
                const sliceH = (currentSlice * maxW) / canvas.width;
                if(page > 0) pdf.addPage();
                pdf.addImage(sliceData, "JPEG", margin, margin, maxW, sliceH);
                yPx += currentSlice;
                page += 1;
            }
        }

        pdf.save(`attendance_${classSelect.value}_${monthSelect.value}.pdf`);
    }catch(err){
        console.error(err);
        alert("Unable to generate PDF.");
    }finally{
        if(btn) btn.textContent = oldLabel || "Export PDF";
        if(host && host.parentNode) host.parentNode.removeChild(host);
    }
}
</script>

</body>
</html>





