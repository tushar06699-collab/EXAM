<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My Exam Datesheet</title>

<style>
:root{
    --primary:#4e73df;
    --bg:#f5f7fb;
    --text:#333;
}
body{
    margin:0;
    font-family:Poppins,system-ui,sans-serif;
    background:var(--bg);
}

/* HEADER */
header{
    background:var(--primary);
    color:#fff;
    padding:10px 20px;
    display:flex;
    justify-content:space-between;
    align-items:center;
}
.menu-btn{font-size:26px;cursor:pointer;}
.student-info{display:flex;align-items:center;gap:10px;}
.student-info img{
    width:38px;height:38px;border-radius:50%;
    border:2px solid #fff;object-fit:cover;
}
.logout{
    background:rgba(255,255,255,.25);
    border:none;color:white;
    padding:6px 12px;border-radius:20px;
}

/* SIDEBAR */
.sidebar{
    position:fixed;top:0;left:-280px;
    width:260px;height:100%;
    background:#fff;padding:20px;
    box-shadow:2px 0 15px rgba(0,0,0,.2);
    transition:.3s;z-index:1001;
}
.sidebar a{display:block;padding:12px 0;color:#333;text-decoration:none;}
.sidebar a.active{font-weight:600;color:var(--primary);}

.overlay{
    position:fixed;inset:0;
    background:rgba(0,0,0,.4);
    display:none;z-index:1000;
}

/* MAIN */
.container{max-width:900px;margin:auto;padding:20px;}
.info{display:flex;justify-content:space-between;font-weight:600;margin-bottom:15px;}

table{
    width:100%;border-collapse:collapse;
    background:#fff;border-radius:10px;
    overflow:hidden;box-shadow:0 3px 10px rgba(0,0,0,.1);
}
th,td{border:1px solid #ddd;padding:10px;text-align:center;}
th{background:var(--primary);color:#fff;}
tr:nth-child(even){background:#f4f6fb;}
</style>
<link rel="stylesheet" href="student_mobile.css"></head>

<body>

<div class="overlay" id="overlay" onclick="closeMenu()"></div>

<div class="sidebar" id="sidebar">
    <h2>Student Menu</h2>
    <a onclick="openPage('student_portal.html')">Dashboard</a>
    <a onclick="openPage('student_results.html')">Results</a>
    <a onclick="openPage('student_timetable.html')">Timetable</a>
    <a class="active">Exams</a>
    <a onclick="openPage('student_hall_ticket.html')">Hall Ticket</a>
    <a onclick="openPage('student_attendance.html')">Attendance</a>
    <a onclick="openPage('student_notices.html')">Notices</a>
    <a onclick="openPage('student_academic_calendar.html')">Academic Calendar</a>

    <hr>
</div>

<header>
    <div>
        <span class="menu-btn" onclick="openMenu()">?</span>
        <span style="font-size:20px;margin-left:10px;">Exam Datesheet</span>
    </div>
    <div class="student-info">
        <img id="headerPhoto" src="images/default.png">
        <span id="headerName">Student</span>
        <button class="logout" onclick="logout()">Logout</button>
    </div>
</header>

<div class="container">

<div class="info">
    <span id="classInfo"></span>
    <span id="sessionInfo">Loading session...</span>
</div>

<label><b>Select Exam</b></label>
<select id="examSelect" style="padding:10px;width:100%;margin-bottom:15px;border-radius:8px;"></select>
<button onclick="downloadPDF()" style="padding:10px 14px;border:none;border-radius:8px;background:#0f766e;color:#fff;cursor:pointer;margin-bottom:12px;">Download PDF</button>

<table>
<thead>
<tr>
    <th>Date</th>
    <th>Subject</th>
</tr>
</thead>
<tbody id="datesheetBody"></tbody>
</table>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
/* ========= AUTH ========= */
if(localStorage.getItem("role") !== "student"){
    location.href="index.html";
}

const studentId = localStorage.getItem("student_id");
const studentClass = localStorage.getItem("class");

if(!studentId || !studentClass){
    location.href="index.html";
}

/* ========= GLOBAL ========= */
const EXAM_API = "https://exam-backend-117372286918.asia-south1.run.app/";
let CURRENT_SESSION = "";

const examSelect = document.getElementById("examSelect");
const body = document.getElementById("datesheetBody");

/* ========= LOAD STUDENT BASIC ========= */
fetch(`${EXAM_API}/portal/student/${studentId}`)
.then(r=>r.json())
.then(d=>{
    if(!d.success) throw "";
    headerName.innerText = d.student.name;
    headerPhoto.src = d.student.photo_url || "images/default.png";
    document.getElementById("classInfo").innerText =
        `Class: ${studentClass} - ${d.student.section}`;
});

/* ========= LOAD SESSION FROM BACKEND ========= */
async function loadSession(){
    const res = await fetch(`${EXAM_API}/session/list`);
    const data = await res.json();

    if(!data.sessions.length){
        document.getElementById("sessionInfo").innerText = "Session not found";
        return;
    }

    CURRENT_SESSION = data.sessions[data.sessions.length - 1];
    document.getElementById("sessionInfo").innerText =
        "Session: " + CURRENT_SESSION;

    loadExams(); //  after session ready
}

/* ========= LOAD EXAMS ========= */
async function loadExams(){
    const res = await fetch(`${EXAM_API}/exam/list-all`);
    const data = await res.json();

    const exams = (data.exams || []).filter(
        e => e.session === CURRENT_SESSION
    );

    examSelect.innerHTML =
        `<option value="">Select Exam</option>` +
        exams.map(e =>
            `<option value="${e.exam_name}">${e.exam_name}</option>`
        ).join("");
}

examSelect.onchange = loadDatesheet;

/* ========= LOAD DATE SHEET ========= */
async function loadDatesheet(){
    body.innerHTML = "";
    const exam = examSelect.value;
    if(!exam) return;

    const res = await fetch(
        `${EXAM_API}/exam/get-datesheet?class_name=${studentClass}&session=${CURRENT_SESSION}&exam_name=${exam}`
    );
    const data = await res.json();

    if(!data.datesheet || !data.datesheet.length){
        body.innerHTML =
            `<tr><td colspan="2">No datesheet found</td></tr>`;
        return;
    }

    data.datesheet.forEach(d=>{
        body.innerHTML += `
        <tr>
            <td>${d.date}</td>
            <td>${d.subject}</td>
        </tr>`;
    });
}

/* ========= UI ========= */
function openMenu(){
    sidebar.style.left="0";
    overlay.style.display="block";
}
function closeMenu(){
    sidebar.style.left="-280px";
    overlay.style.display="none";
}
function openPage(p){location.href=p;}
function logout(){
    localStorage.clear();
    location.href="index.html";
}

async function downloadPDF(){
    const exam = examSelect.value;
    if(!exam) return alert("Select exam first.");
    if(!body.querySelector("tr")) return alert("Load datesheet first.");

    const jsPDFCtor = window.jspdf && window.jspdf.jsPDF;
    if(!jsPDFCtor || typeof window.html2canvas === "undefined"){
        return alert("PDF library not loaded. Refresh and try again.");
    }

    const host = document.createElement("div");
    host.style.position = "fixed";
    host.style.left = "-99999px";
    host.style.top = "0";
    host.style.width = "1100px";
    host.style.background = "#fff";
    host.style.padding = "10px";
    host.style.fontFamily = "Poppins, sans-serif";
    host.innerHTML = `<h3 style="margin:0 0 8px 0;">Exam Datesheet - ${exam}</h3>
                      <div style="margin:0 0 10px 0;">Class: ${studentClass} | Session: ${CURRENT_SESSION}</div>`;
    host.appendChild(document.querySelector("table").cloneNode(true));
    document.body.appendChild(host);

    try{
        const canvas = await window.html2canvas(host, {scale:2, useCORS:true, backgroundColor:"#fff"});
        const img = canvas.toDataURL("image/jpeg", 0.95);
        const pdf = new jsPDFCtor("p","mm","a4");
        const pageW=210, pageH=297, margin=8, maxW=pageW-margin*2, maxH=pageH-margin*2;
        let w=maxW, h=(canvas.height*w)/canvas.width;
        if(h<=maxH){
            const x=(pageW-w)/2, y=(pageH-h)/2;
            pdf.addImage(img,"JPEG",x,y,w,h);
        }else{
            const pageCanvas=document.createElement("canvas");
            const ctx=pageCanvas.getContext("2d");
            const sliceHeightPx=Math.floor(canvas.width*(maxH/maxW));
            pageCanvas.width=canvas.width;
            let yPx=0, page=0;
            while(yPx<canvas.height){
                const cur=Math.min(sliceHeightPx, canvas.height-yPx);
                pageCanvas.height=cur;
                ctx.clearRect(0,0,pageCanvas.width,pageCanvas.height);
                ctx.drawImage(canvas,0,yPx,canvas.width,cur,0,0,canvas.width,cur);
                const slice=pageCanvas.toDataURL("image/jpeg",0.95);
                const sliceH=(cur*maxW)/canvas.width;
                if(page>0) pdf.addPage();
                pdf.addImage(slice,"JPEG",margin,margin,maxW,sliceH);
                yPx+=cur; page+=1;
            }
        }
        pdf.save(`student_datesheet_${exam}_${CURRENT_SESSION}.pdf`);
    }catch(e){
        console.error(e);
        alert("Unable to generate PDF.");
    }finally{
        if(host.parentNode) host.parentNode.removeChild(host);
    }
}

/* ========= INIT ========= */
loadSession();
</script>

  <script src="student_sidebar_shared.js"></script>
</body>
</html>








