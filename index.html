<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Login</title>
<meta name="viewport" content="width=device-width">
<style>
body{
    margin:0;
    font-family:Poppins, sans-serif;
    background:#eef2f7;
    display:flex;
    justify-content:center;
    align-items:center;
    height:100vh;
}
.box{
    background:white;
    padding:30px;
    width:340px;
    border-radius:12px;
    box-shadow:0 4px 12px rgba(0,0,0,0.1);
    position:relative;
    z-index:1;

}
input{
    width:100%;
    margin-bottom:15px;
    padding:10px;
    border-radius:8px;
    border:1px solid #ccc;
}
button{
    width:100%;
    padding:12px;
    background:#4e73df;
    border:none;
    color:white;
    border-radius:8px;
    font-size:16px;
    cursor:pointer;
}
.error{
    color:red;
    margin-top:10px;
    text-align:center;
}
/* BACKGROUND IMAGE */
body{
    background:url("images/event3.png") no-repeat center center/cover;
}

/* DARK OVERLAY */
body::before{
    content:"";
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.45);
    z-index:0;
}
/* LOGIN HEADER (LOGO + TEXT) */
.login-header{
    display:flex;
    align-items:center;
    justify-content:center;
    gap:10px;
    margin-bottom:20px;
}

.login-header img{
    width:90px;
    height:90px;
    object-fit:contain;
}

.login-header h1{
    margin:0;
}

</style>
</head>
<body>

<div class="box">
<div class="login-header">
    <img src="images/logo1.png" alt="School Logo">
    <h1>Portal Login</h1>
</div>
    
    <input id="user" placeholder="Username / Roll No">
    <input id="pass" placeholder="Password / DOB (DDMMYYYY)" type="password">
    
    <button onclick="login()">Login</button>
    <div id="err" class="error"></div>
</div>

<script>
const API = "https://exam-backend-117372286918.asia-south1.run.app/";

// ---------- ELEMENT REFERENCES ----------
const userInput = document.getElementById("user");
const passInput = document.getElementById("pass");
const errDiv = document.getElementById("err");

/* ---------- DOB CANDIDATES (STUDENT ONLY) ---------- */
function getDOBCandidates(input){
    const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    const out = [];
    const raw = String(input || "").trim();

    // Accept DDMMYYYY from login input
    if (/^\d{8}$/.test(raw)) {
        const d = parseInt(raw.slice(0,2), 10);
        const m = parseInt(raw.slice(2,4), 10);
        const y = parseInt(raw.slice(4,8), 10);
        if (m >= 1 && m <= 12 && d >= 1 && d <= 31) {
            const dd = String(d).padStart(2, "0");
            const mm = String(m).padStart(2, "0");
            const mmm = months[m - 1];
            out.push(`${mmm} ${dd}, ${y}`); // Dec 29, 2018
            out.push(`${mmm} ${d}, ${y}`);  // Dec 9, 2018
            out.push(`${y}-${mm}-${dd}`);   // 2018-12-29
            out.push(`${dd}-${mm}-${y}`);   // 29-12-2018
            out.push(`${dd}/${mm}/${y}`);   // 29/12/2018
        }
    }

    // If user already types a date-like value, try it directly too.
    if (raw) out.push(raw);

    // Unique, keep order
    return [...new Set(out)];
}

/* ---------- LOGIN ---------- */
async function login(){
    const username = userInput.value.trim();
    const rawPassword = passInput.value.trim();
    errDiv.innerText = "";

     if(username === "PSPSLIB" && rawPassword === "14112017"){
        window.location.href = "https://library-kohl-eight.vercel.app/issue_return.html";
        return;
    }

     if(username === "PSPSSTU" && rawPassword === "14112017"){
        window.location.href = "https://student-frontend-mocha.vercel.app/";
        return;
    }

    if(!username || !rawPassword){
        errDiv.innerText = "Enter username and password";
        return;
    }

    // STEP 1 - TRY NORMAL LOGIN (ADMIN / TEACHER / PRINCIPAL)
    let response = await fetch(API + "/login", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ username, password: rawPassword })
    });

    let res = await response.json();

    // STEP 2 - IF FAILED, TRY STUDENT DOB LOGIN (multiple date formats)
    if(!res.success){
        const dobCandidates = getDOBCandidates(rawPassword);
        if(!dobCandidates.length){
            errDiv.innerText = res.message || "Invalid credentials";
            return;
        }

        let loggedIn = false;
        for (const dob of dobCandidates) {
            response = await fetch(API + "/login", {
                method:"POST",
                headers:{ "Content-Type":"application/json" },
                body: JSON.stringify({ username, password: dob })
            });

            res = await response.json();
            if (res.success) {
                loggedIn = true;
                break;
            }
        }

        if(!loggedIn){
            errDiv.innerText = res.message || "Login failed";
            return;
        }
    }

    // ---------- SAVE COMMON DATA ----------
    localStorage.setItem("token", res.token);
    localStorage.setItem("role", res.role);

    // ---------- ROLE ROUTING ----------
    if(res.role === "admin"){
        window.location.href = "dashboard.html";
        return;
    }

    if(res.role === "principal"){
        localStorage.setItem("principal_name", res.principal?.name || "Principal");
        window.location.href = "principal_dashboard.html";
        return;
    }

    if(res.role === "teacher"){
        localStorage.setItem("teacher_id", res.teacher.id);
        localStorage.setItem("teacher_name", res.teacher.name);
        localStorage.setItem("teacher_username", res.teacher.username);
        localStorage.setItem("session", res.teacher.session);
        window.location.href = "teacher_dashboard.html";
        return;
    }

    if(res.role === "student"){
    localStorage.setItem("student_id", res.student.id);
    localStorage.setItem("student_name", res.student.name);
    localStorage.setItem("roll", res.student.admission_no);       // admission no
    localStorage.setItem("rollno", res.student.rollno);           // actual roll number (used by marks API)
    localStorage.setItem("class", res.student.class);         
    localStorage.setItem("section", res.student.section);
    localStorage.setItem("session", res.student.session);
    localStorage.setItem("photo_url", res.student.photo || "");
    window.location.href = "student_portal.html";
    return;
}

    errDiv.innerText = "Unknown role!";
}
</script>

</body>
</html>





