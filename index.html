<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Login</title>
<meta name="viewport" content="width=device-width">
<style>
body{
    margin:0;
    font-family:Poppins, sans-serif;
    background:#eef2f7;
    display:flex;
    justify-content:center;
    align-items:center;
    height:100vh;
}
.box{
    background:white;
    padding:30px;
    width:340px;
    border-radius:12px;
    box-shadow:0 4px 12px rgba(0,0,0,0.1);
}
input{
    width:100%;
    margin-bottom:15px;
    padding:10px;
    border-radius:8px;
    border:1px solid #ccc;
}
button{
    width:100%;
    padding:12px;
    background:#4e73df;
    border:none;
    color:white;
    border-radius:8px;
    font-size:16px;
    cursor:pointer;
}
.error{
    color:red;
    margin-top:10px;
    text-align:center;
}
</style>
</head>
<body>

<div class="box">
    <h2 style="text-align:center;">Login</h2>
    
    <input id="user" placeholder="Username / Roll No">
    <input id="pass" placeholder="Password / DOB (DDMMYYYY)" type="password">
    
    <button onclick="login()">Login</button>
    <div id="err" class="error"></div>
</div>

<script>
const API = "https://exam-backend-ko0t.onrender.com";

// ---------- ELEMENT REFERENCES ----------
const userInput = document.getElementById("user");
const passInput = document.getElementById("pass");
const errDiv = document.getElementById("err");

/* ---------- DOB NORMALIZER (STUDENT ONLY) ---------- */
function normalizeDOB(input){
    const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    input = input.trim();

    if (/^\d{8}$/.test(input)) {
        const d = input.slice(0,2);
        const m = input.slice(2,4);
        const y = input.slice(4,8);
        if (+m < 1 || +m > 12) return "";
        return `${months[m-1]} ${d}, ${y}`;
    }
    return "";
}

/* ---------- LOGIN ---------- */
async function login(){
    const username = userInput.value.trim();
    const rawPassword = passInput.value.trim();
    errDiv.innerText = "";

    if(!username || !rawPassword){
        errDiv.innerText = "Enter username and password";
        return;
    }

    // STEP 1 — TRY NORMAL LOGIN (ADMIN / TEACHER / PRINCIPAL)
    let response = await fetch(API + "/login", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ username, password: rawPassword })
    });

    let res = await response.json();

    // STEP 2 — IF FAILED, TRY STUDENT DOB LOGIN
    if(!res.success){
        const dob = normalizeDOB(rawPassword);
        if(!dob){
            errDiv.innerText = res.message || "Invalid credentials";
            return;
        }

        response = await fetch(API + "/login", {
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body: JSON.stringify({ username, password: dob })
        });

        res = await response.json();
        if(!res.success){
            errDiv.innerText = res.message || "Login failed";
            return;
        }
    }

    // ---------- SAVE COMMON DATA ----------
    localStorage.setItem("token", res.token);
    localStorage.setItem("role", res.role);

    // ---------- ROLE ROUTING ----------
    if(res.role === "admin"){
        window.location.href = "dashboard.html";
        return;
    }

    if(res.role === "principal"){
        localStorage.setItem("principal_name", res.principal?.name || "Principal");
        window.location.href = "principal_dashboard.html";
        return;
    }

    if(res.role === "teacher"){
        localStorage.setItem("teacher_id", res.teacher.id);
        localStorage.setItem("teacher_name", res.teacher.name);
        localStorage.setItem("teacher_username", res.teacher.username);
        localStorage.setItem("session", res.teacher.session);
        window.location.href = "teacher_dashboard.html";
        return;
    }

    if(res.role === "student"){
    localStorage.setItem("student_id", res.student.id);
    localStorage.setItem("student_name", res.student.name);
    localStorage.setItem("roll", res.student.admission_no);       // admission no
    localStorage.setItem("rollno", res.student.rollno);           // actual roll number (used by marks API)
    localStorage.setItem("class", res.student.class);         
    localStorage.setItem("section", res.student.section);
    localStorage.setItem("session", res.student.session);
    localStorage.setItem("photo_url", res.student.photo || "");
    window.location.href = "student_portal.html";
    return;
}

    errDiv.innerText = "Unknown role!";
}
</script>

</body>
</html>
