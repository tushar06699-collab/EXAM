<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Principal Marks Upload - School ERP</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{margin:0;font-family:Poppins,sans-serif;background:#f2f4f7;display:flex;}
.sidebar{width:240px;background:#233465;color:white;height:100vh;position:fixed;left:0;top:0;padding-top:20px;}
.sidebar h2{text-align:center;font-size:22px;margin-bottom:25px;}
.sidebar a{display:block;padding:12px 20px;color:white;text-decoration:none;font-size:16px;}
.sidebar a:hover{background:rgba(255,255,255,0.25);}
.sidebar a.active{background:rgba(255,255,255,0.35);}
.content{margin-left:240px;width:calc(100% - 240px);padding:20px;}
header{background:#233465;color:#fff;padding:1rem;text-align:center;font-size:1.5rem;border-radius:8px;}
main{max-width:700px;margin:2rem auto;background:#fff;padding:2rem;border-radius:12px;box-shadow:0 2px 12px rgba(0,0,0,0.1);}
label{display:block;font-weight:600;margin-top:15px;}
select,input{width:100%;padding:10px;margin-top:5px;border:1px solid #ccc;border-radius:6px;}
button{margin-top:20px;width:100%;padding:12px;background:#4f46e5;color:white;border:none;font-size:16px;border-radius:6px;cursor:pointer;}
button:hover{background:#3730a3;}
table{width:100%;border-collapse:collapse;margin-top:20px;}
th,td{border:1px solid #ccc;padding:8px;text-align:center;}
th{background:#233465;color:white;}
.low-mark{background:#f87171;color:white;}
.total-marks{margin-top:10px;font-weight:bold;font-size:1.1rem;}
.export-btn{background:#f59e0b;margin-top:10px;}
</style>
<link rel="stylesheet" href="admin_theme.css">
</head>

<body>

<div class="sidebar">
  <h2>School ERP</h2>
  <a href="principal_dashboard.html">Dashboard</a>
  <a href="principal_marks.html" class="active">Upload Students Marks</a>
  <a href="principal_exam_eligibility.html">Exam Eligibility</a>
  <a href="principal_marksheet.html">Generate Marksheet</a>
</div>

<div class="content">
<header>Upload Student Marks</header>
<main>

<label>Session</label>
<select id="sessionSelect"></select>

<label>Class</label>
<select id="classSelect"></select>

<label>Subject</label>
<select id="subjectSelect"></select>

<label>Exam</label>
<select id="examSelect"></select>
<div class="total-marks" id="totalMarks"></div>

<button onclick="loadStudents()">Load Students</button>

<div id="tableContainer"></div>

<button onclick="uploadMarks()" style="background:#1e8f3d;">Upload Marks</button>
<button onclick="exportCSV()" class="export-btn">Export CSV</button>

</main>
</div>

<script>
const EXAM_API = "https://exam-backend-ko0t.onrender.com";
const STUDENT_API = "https://student-backend-117372286918.asia-south1.run.app/";

let EXAMS = [];
let TOTAL_MARKS = 0;

async function resolveExternalMaxMarks(session, cls, sub, examData){
    if(!session || !cls || !sub || !examData) return Number(examData?.total_marks || 0);
    try{
        const res = await fetch(`${EXAM_API}/exam/subject-config/get?session=${encodeURIComponent(session)}&class_name=${encodeURIComponent(cls)}&exam_name=${encodeURIComponent(examData.exam_name)}&subject=${encodeURIComponent(sub)}`);
        const data = await res.json();
        if(data.success && data.config && data.config.external_max_marks != null){
            return Number(data.config.external_max_marks);
        }
    }catch(_e){}
    return Number(examData.total_marks || 0);
}

async function loadSessions() {
    const res = await fetch(`${EXAM_API}/session/list`);
    const data = await res.json();
    sessionSelect.innerHTML = data.sessions.map(s=>`<option>${s}</option>`).join("");
    if(data.sessions.length>0){
        sessionSelect.value = data.sessions[0];
        loadClasses();
    }
}
loadSessions();
sessionSelect.addEventListener("change", loadClasses);

async function loadClasses() {
    const session = sessionSelect.value;
    if(!session) return;
    const res = await fetch(`${STUDENT_API}/students?session=${session}`);
    const students = await res.json();
    const classes = [...new Set(students.map(s=>s.class_name).filter(Boolean))];
    classSelect.innerHTML = `<option value="">Select Class</option>` + classes.map(c=>`<option value="${c}">${c}</option>`).join("");
    if(classes.length>0){
        classSelect.value = classes[0];
        loadExams();
        loadSubjects();
    }
}
classSelect.addEventListener("change", loadSubjects);

async function loadExams() {
    const res = await fetch(`${EXAM_API}/exam/list-all`);
    const data = await res.json();
    if(!data.success) return alert("Exam load error");
    EXAMS = data.exams;
    examSelect.innerHTML = `<option value="">Select Exam</option>` + EXAMS.map(e=>`<option value="${e.exam_id}" data-total="${e.total_marks}">${e.exam_name}</option>`).join("");
}
loadExams();

examSelect.addEventListener("change", ()=>{
    const selected = EXAMS.find(e=>e.exam_id==examSelect.value);
    TOTAL_MARKS = selected ? selected.total_marks : 0;
    totalMarks.textContent = selected ? `Total Marks: ${TOTAL_MARKS}` : "";
    loadStudents();
});

async function loadSubjects() {
    const cls = classSelect.value;
    if(!cls) return;
    const session = sessionSelect.value;
    const res = await fetch(`${EXAM_API}/exam/subjects/get?session=${encodeURIComponent(session)}&class_name=${encodeURIComponent(cls)}`);
    const data = await res.json();
    if(data.success){
        subjectSelect.innerHTML = data.subjects.map(s=>`<option>${s}</option>`).join("");
        loadStudents();
    }
}
subjectSelect.addEventListener("change", loadStudents);

async function loadStudents() {
    const session = sessionSelect.value;
    const cls = classSelect.value;
    const sub = subjectSelect.value;
    const examId = examSelect.value;
    if(!cls || !sub || !examId) return;
    const examData = EXAMS.find(e=>e.exam_id==examId);
    if(!examData) return;

    TOTAL_MARKS = await resolveExternalMaxMarks(session, cls, sub, examData);
    totalMarks.textContent = `External Max Marks (${sub}): ${TOTAL_MARKS}`;

    const res = await fetch(`${STUDENT_API}/students?session=${session}`);
    const students = await res.json();
    const classStudents = students
      .filter(s => s.class_name === cls)
      .sort((a, b) => {
        const r1 = parseInt(a.rollno) || 0;
        const r2 = parseInt(b.rollno) || 0;
        return r1 - r2;
      });

    let html = `<table><tr><th>Roll No</th><th>Name</th><th>Marks</th><th>Percent</th></tr>`;
    classStudents.forEach(s=>{
        html += `<tr>
            <td>${s.rollno}</td>
            <td>${s.student_name}</td>
            <td><input type="number" data-roll="${s.rollno}" min="0"></td>
            <td class="percent-cell"></td>
        </tr>`;
    });
    html += `</table>`;
    document.getElementById("tableContainer").innerHTML = html;
    await loadExistingMarks();
    updatePercentColors();
}

async function loadExistingMarks() {
    const session = sessionSelect.value;
    const cls = classSelect.value;
    const sub = subjectSelect.value;
    const examId = examSelect.value;
    if(!cls || !sub || !examId) return;
    const examData = EXAMS.find(e=>e.exam_id==examId);
    if(!examData) return;

    try{
        const res = await fetch(`${EXAM_API}/exam/get-marks?session=${encodeURIComponent(session)}&class_name=${encodeURIComponent(cls)}&exam_name=${encodeURIComponent(examData.exam_name)}`);
        const data = await res.json();
        if(!data.success) return;
        data.marks.filter(m=>m.subject===sub).forEach(m=>{
            const input = document.querySelector(`input[data-roll='${m.roll}']`);
            if(input) input.value = m.marks;
        });
        updatePercentColors();
    }catch(err){
        console.error("Error loading marks:", err);
    }
}

function updatePercentColors(){
    const rows = document.querySelectorAll("#tableContainer table tr");
    rows.forEach((tr,i)=>{
        if(i===0) return;
        const markInput = tr.querySelector("input[data-roll]");
        const percentCell = tr.querySelector(".percent-cell");
        if(markInput){
            const marks = Number(markInput.value);
            const percent = TOTAL_MARKS ? ((marks / TOTAL_MARKS) * 100).toFixed(2) : 0;
            percentCell.textContent = percent + "%";
            if(marks < TOTAL_MARKS / 3){
                markInput.classList.add("low-mark");
                percentCell.classList.add("low-mark");
            }else{
                markInput.classList.remove("low-mark");
                percentCell.classList.remove("low-mark");
            }
            markInput.addEventListener("input", updatePercentColors);
        }
    });
}

async function uploadMarks(){
    const session = sessionSelect.value;
    const examId = examSelect.value;
    const cls = classSelect.value;
    const sub = subjectSelect.value;
    if(!examId || !cls || !sub) return alert("Select exam, class, and subject!");

    const examData = EXAMS.find(e=>e.exam_id==examId);
    if(!examData) return;

    const rows = document.querySelectorAll("input[data-roll]");
    const marksList = Array.from(rows).map(r=>({
        roll: r.dataset.roll,
        subject: sub,
        marks: r.value || 0
    }));

    try{
        const res = await fetch(`${EXAM_API}/exam/add-marks`,{
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body: JSON.stringify({
                session,
                class_name: cls,
                exam_name: examData.exam_name,
                marks: marksList
            })
        });
        const data = await res.json();
        alert(data.message || "Marks uploaded!");
    }catch(err){
        console.error(err);
        alert("Error uploading marks");
    }
}

function exportCSV(){
    const table = document.querySelector("#tableContainer table");
    if(!table) return alert("No data to export!");
    const csv = [];
    const rows = table.querySelectorAll("tr");
    rows.forEach(tr=>{
        const row = [];
        tr.querySelectorAll("th,td").forEach(td=>{
            const input = td.querySelector("input");
            if(input){
                row.push(input.value);
            }else{
                row.push(td.textContent.trim());
            }
        });
        csv.push(row.join(","));
    });
    const blob = new Blob([csv.join("\n")],{type:"text/csv"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `principal_marks_${Date.now()}.csv`;
    a.click();
    URL.revokeObjectURL(url);
}
</script>

</body>
</html>


