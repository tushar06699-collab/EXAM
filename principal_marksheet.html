<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Marksheet – School ERP</title>

<style>
:root{
  --brand:#233465;
  --accent:#4f46e5;
  --muted:#f2f4f7;
  --fail-bg:#ef4444;
}

html,body{
  margin:0;
  font-family:Poppins,Segoe UI,Roboto,Helvetica,Arial;
  background:var(--muted);
}

/* ===== SIDEBAR ===== */
.sidebar{
  width:240px;
  background:var(--brand);
  color:#fff;
  height:100vh;
  position:fixed;
  left:0;
  top:0;
  padding-top:20px;
}
.sidebar h2{ text-align:center; margin-bottom:18px; }
.sidebar a{
  display:block;
  padding:12px 18px;
  color:#fff;
  text-decoration:none;
}
.sidebar a:hover{ background:rgba(255,255,255,0.1); }

.content{ margin-left:240px; padding:20px; }

/* ===== CONTROLS ===== */
.controls{
  display:flex;
  gap:12px;
  flex-wrap:wrap;
  margin-bottom:12px;
}
.controls > div{ flex:1; min-width:140px; }

select,button{
  padding:8px 10px;
  border-radius:6px;
  border:1px solid #ccc;
}
button{
  background:var(--accent);
  color:#fff;
  border:none;
  cursor:pointer;
}

.marksheet-container{ display:none; }

/* ===== MARKSHEET ===== */
.marksheet{
  width:210mm;
  min-height:297mm;
  background:#fff;
  margin:0 auto 30px;
  padding:18mm;
  position:relative;
  box-shadow:0 0 10px rgba(0,0,0,.15);
  page-break-after:always;
}

/* SCHOOL LOGO */
.school-logo{
  position:absolute;
  top:18mm;
  left:18mm;
  width:130px;
  height:auto;
  object-fit:contain;
}

/* STUDENT PHOTO */
.student-photo{
  position:absolute;
  top:18mm;
  right:18mm;
  width:150px;
  height:180px;
  border:2px solid #333;
  object-fit:cover;
}

.marksheet header{
  text-align:center;
  margin-bottom:15px;
}
.marksheet header h1{
  margin:0;
  font-size:30px;
  color:#233465;
}
.marksheet header h2{
  margin:5px 0;
  color:#4f46e5;
}

.student-info{
  display:flex;
  flex-wrap:wrap;
  justify-content:space-between;
  font-size:14px;
  margin-top:10px;
}
.student-info div{
  width:48%;
  margin-bottom:6px;
}

table{
  width:100%;
  border-collapse:collapse;
  margin-top:15px;
}
th,td{
  border:1px solid #000;
  padding:7px;
  text-align:center;
  font-size:14px;
}
th{ background:#f0f0f0; }

tr.fail td{
  background:var(--fail-bg);
  color:#fff;
}

.summary{
  display:flex;
  justify-content:space-between;
  margin-top:15px;
  font-size:15px;
}

.result-status{
  margin-top:10px;
  font-size:18px;
  font-weight:bold;
  text-align:center;
}
.pass{ color:green; }
.fail-text{ color:red; }

.sign-block{
  display:flex;
  justify-content:space-between;
  margin-top:50px;
}
.sign-box{
  width:40%;
  text-align:center;
  border-top:2px solid #000;
  padding-top:6px;
}

.school-stamp{
  margin:30px auto 0;
  text-align:center;
  font-weight:bold;
  border:2px solid #000;
  width:220px;
  padding:8px;
}
.holistic-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr); /* 2 items per row */
  gap: 5px 40px; /* row gap, column gap */
  font-family: 'Poppins', sans-serif;
  font-size: 14px;
  color: #333;
}

.holistic-grid div {
  background: #f7f9fc;
  padding: 8px 12px;
  border-radius: 3px;
}

.holistic-grid b {
  color: #233465;
}

/* ===== PRINT ===== */
@media print{
  body{ background:#fff; }
  .sidebar,.controls{ display:none; }
  .content{ margin:0; padding:0; }
  .marksheet{ box-shadow:none; }
}
</style>
</head>

<body>

<div class="sidebar">
  <h2>School ERP</h2>
  <a href="principal_dashboard.html">Dashboard</a>
  <a href="principal_marks.html">Uploaded Marks</a>
  <a href="principal_marksheet.html" style="background: rgba(255,255,255,0.08);">Marksheet</a>
</div>

<div class="content">
  <h3>Generate Marksheets</h3>

  <div class="controls">
    <div>
      <label>Session</label>
      <select id="sessionSelect"></select>
    </div>
    <div>
      <label>Class</label>
      <select id="classSelect"></select>
    </div>
    <div>
      <label>Exam</label>
      <select id="examSelect"></select>
    </div>
    <div>
      <button onclick="generateMarksheets()">Generate</button>
      <button onclick="window.print()">Print</button>
    </div>
  </div>

  <div id="marksheetContainer" class="marksheet-container"></div>
</div>

<script>
const STUDENT_API = "https://students-backend-8mup.onrender.com";
const EXAM_API = "https://exam-backend-ko0t.onrender.com";

let STUDENTS=[], EXAMS=[];

function safe(v){ return v ?? ""; }
function safePhoto(url){
  return url && url.trim() ? url : "images/default.png";
}

/* LOAD SESSIONS */
async function loadSessions(){
  const r = await fetch(`${EXAM_API}/session/list`);
  const d = await r.json();
  sessionSelect.innerHTML = d.sessions.map(s=>`<option>${s}</option>`).join("");
  loadClasses();
}
loadSessions();

/* LOAD CLASSES */
async function loadClasses(){
  const res = await fetch(`${STUDENT_API}/students?session=${sessionSelect.value}`);
  STUDENTS = await res.json();
  const classes=[...new Set(STUDENTS.map(s=>s.class_name))];
  classSelect.innerHTML = classes.map(c=>`<option>${c}</option>`).join("");
  loadExams();
}
sessionSelect.onchange = loadClasses;

/* LOAD EXAMS */
async function loadExams(){
  const r = await fetch(`${EXAM_API}/exam/list-all`);
  const d = await r.json();
  EXAMS = d.exams;
  examSelect.innerHTML = EXAMS.map(e =>
    `<option value="${e.exam_name}">${e.exam_name}</option>`
  ).join("");
}

/* GENERATE MARKSHEETS */
async function generateMarksheets(){
  const cls = classSelect.value;
  const exam = examSelect.value;
  const container = document.getElementById("marksheetContainer");
  container.innerHTML="";

  const resMarks = await fetch(
    `${EXAM_API}/exam/get-marks?session=${sessionSelect.value}&class_name=${cls}&exam_name=${exam}`
  );
  const mdata = await resMarks.json();
  if(!mdata.success) return alert("No marks found");

  const markMap={};
  mdata.marks.forEach(m=>{
    if(!markMap[m.roll]) markMap[m.roll]={};
    markMap[m.roll][m.subject]=m.marks;
  });

  const sortedStudents = STUDENTS
    .filter(s=>s.class_name===cls)
    .sort((a,b)=>(parseInt(a.rollno)||0)-(parseInt(b.rollno)||0));

  for(const s of sortedStudents){
    const subs = markMap[s.rollno];
    if(!subs) continue;

    const examObj = EXAMS.find(e=>e.exam_name===exam);
    const maxPerSubject = examObj ? examObj.total_marks : 100;

    let total=0, totalMax=0, fail=false;

    const rows = Object.keys(subs).map(sub=>{
      const m = subs[sub] ?? 0;
      const passMarks = Math.ceil(maxPerSubject * 0.33);
      total+=m; totalMax+=maxPerSubject;
      if(m < passMarks) fail=true;

      return `<tr class="${m<passMarks?'fail':''}">
        <td>${sub}</td><td>${m}</td><td>${maxPerSubject}</td>
      </tr>`;
    }).join("");

    const percent=((total/totalMax)*100).toFixed(2);
    const result = fail ? "FAIL" : "PASS";

    container.innerHTML+=`
    <div class="marksheet">

      <img class="school-logo" src="images/school_logo.png" onerror="this.style.display='none'">

      <img class="student-photo"
        src="${safePhoto(s.photo_url)}"
        onerror="this.onerror=null;this.src='images/default.png';">

      <header>
        <h1>P.S. Public School</h1>
        <h3>On Gannaur Road Bhurri (Sonipat)</h3>
        <h2>${exam} Marksheet</h2>
      </header>

      <div class="student-info">
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        

        <div><b>Name:</b> ${safe(s.student_name)}</div>
        <div><b>Admission No:</b> ${safe(s.admission_no)}</div>
        <div><b>Roll No:</b> ${safe(s.rollno)}</div>
        <div><b>Class:</b> ${safe(s.class_name)} ${safe(s.section)}</div>
        <div><b>Father:</b> ${safe(s.father_name)}</div>
        <div><b>Mother:</b> ${safe(s.mother_name)}</div>
        <div><b>DOB:</b> ${safe(s.dob)}</div>
        <div><b>Session:</b> ${safe(s.session)}</div>
      </div>

      <table>
        <tr><th>Subject</th><th>Marks</th><th>Max</th></tr>
        ${rows}
      </table>

      <div class="summary">
        <div><b>Total:</b> ${total} / ${totalMax}</div>
        <div><b>Percentage:</b> ${percent}%</div>
      </div>
        <div></div>
        <div></div>
       <div class="holistic-grid">
  <div><b>Attendance:</b> A</div>
  <div><b>Discipline:</b> A</div>

  <div><b>Sports Skill:</b> A</div>
  <div><b>Co-Curricular Activities:</b> A</div>

  <div><b>Health & Cleanliness:</b> A</div>
  <div><b>Teacher’s Remarks:</b> Shows good performance.</div>
 </div>

      <div class="result-status ${result==='PASS'?'pass':'fail-text'}">
        RESULT: ${result}
      </div>

      <div class="sign-block">
        <div class="sign-box">Class Incharge</div>
        <div class="sign-box">Principal</div>
      </div>

      <div class="school-stamp">.......Exam Department....... P.S. Public School</div>
    </div>`;
  }

  container.style.display="block";
}
</script>

</body>
</html>
