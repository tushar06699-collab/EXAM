<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Teacher Internal Marks Upload â€“ School ERP</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
    margin:0;
    font-family:Poppins,sans-serif;
    background:#ffffff;
    display:flex;
}

/* Hamburger button for mobile */
#hamburger {
    display: none; /* hidden on desktop */
    position: fixed;
    top: 15px;
    left: 15px;
    width: 30px;
    height: 25px;
    cursor: pointer;
    z-index: 1002;
}
#hamburger span {
    display: block;
    height: 3px;
    width: 100%;
    background: white;
    margin-bottom: 5px;
    border-radius: 2px;
}

/* Sidebar */
.sidebar{
    width:240px;
    background:#233465;
    color:white;
    height:100vh;
    position:fixed;
    left:0;
    top:0;
    padding-top:20px;
    transition: transform 0.3s ease;
    z-index: 1000;
}
.sidebar.hidden{
    transform: translateX(-260px);
}
.sidebar.show{
    transform: translateX(0);
}

.sidebar h2{text-align:center;font-size:22px;margin-bottom:25px;}
.sidebar a{display:block;padding:12px 20px;color:white;text-decoration:none;font-size:16px;}
.sidebar a:hover{background:rgba(255,255,255,0.25);}
.sidebar a.active{background:rgba(255,255,255,0.35);}

/* Content */
.content{
    margin-left:240px;
    width:calc(100% - 240px);
    padding:20px;
    transition: margin-left 0.3s ease;
}
.content.shifted{
    margin-left:0;
}

/* Header & main */
header{background:#233465;color:#fff;padding:1rem;text-align:center;font-size:1.5rem;border-radius:8px;}
main{max-width:1300px;margin:2rem auto;background:#fff;padding:2rem;border-radius:0px;box-shadow:none;}
label{display:block;font-weight:600;margin-top:15px;}
select,input{width:100%;padding:10px;margin-top:5px;border:1px solid #ccc;border-radius:6px;}
button{margin-top:20px;width:100%;padding:12px;background:#4f46e5;color:white;border:none;font-size:16px;border-radius:6px;cursor:pointer;}
button:hover{background:#3730a3;}
table{width:100%;border-collapse:collapse;margin-top:20px;}
th,td{border:1px solid #ccc;padding:8px;text-align:center;}
th{background:#233465;color:white;}
.low-mark{background:#f87171;color:white;}
.export-btn{background:#f59e0b;margin-top:10px;}

/* Responsive for mobile */
@media screen and (max-width: 768px){
    #hamburger { display: block; }
    .sidebar{ transform: translateX(-260px); }
    .sidebar.show{ transform: translateX(0);}
    .content{ margin-left:0; }
    .content.shifted{ margin-left:240px; }
}/* ===== TABLE MOBILE FIX ===== */
#tableContainer{
    width:100%;
    overflow-x:auto;          /* allow horizontal scroll */
}

#tableContainer table{
    width:100%;
    min-width:600px;          /* prevents squeezing */
    table-layout:auto;
    background:#fff;
}

#tableContainer input{
    min-width:70px;
}

/* Mobile specific */
@media screen and (max-width: 768px){
    main{
        max-width:100%;       /* remove 700px limit */
        padding:1rem;
    }

    th, td{
        white-space:nowrap;   /* keep columns readable */
    }
}
/* ===== MOBILE FULL WIDTH FIX ===== */
@media screen and (max-width: 768px){

    body{
        display:block;        /* stop flex squeezing */
    }

    .content{
        width:100% !important;
        margin-left:0 !important;
        padding:14px;
    }

    header{
        margin-left:0;
    }

    main{
        width:100%;
        max-width:100%;
        margin:1rem auto;
    }
}

</style>
</head>

<body>

<!-- Hamburger button -->
<div id="hamburger">
    <span></span>
    <span></span>
    <span></span>
</div>

<div class="sidebar" id="sidebar">
<h2>School ERP</h2>
<a href="teacher_dashboard.html">Dashboard</a>
<a href="view_notices.html">Notices and Circular</a>
<a href="teacher_my_classes.html">My Time Table</a>
<a href="teacher_attendance.html">Upload Student Attendance</a>
<a href="teacher_view_datesheet.html">View Datesheet</a>
<a href="teacher_papers.html">Upload Question Papers</a>
<a href="teacher_internal_marks_upload.html" style="background: rgba(255,255,255,0.25);">Upload Internal Marks</a>
<a href="teacher_marks_upload.html">Upload External Marks</a>
<a href="teacher_leave.html">Leave Permission</a>
</div>

<div class="content" id="content">
<header>Upload Internal Marks</header>
<main>

<label>Session</label>
<select id="sessionSelect"></select>

<label>Class</label>
<select id="classSelect"></select>

<label>Exam</label>
<select id="examSelect"></select>

<label>Subject</label>
<select id="subjectSelect"></select>

<button onclick="loadStudents()">Load Students</button>

<div id="tableContainer"></div>

<button onclick="uploadInternalMarks()" style="background:#1e8f3d;">Upload Internal Marks</button>
<button onclick="exportCSV()" class="export-btn">Export CSV</button>

</main>
</div>

<script>
const EXAM_API = "https://exam-backend-ko0t.onrender.com";
const STUDENT_API = "https://students-backend-8mup.onrender.com";

// teacher info (from login)
const TEACHER_ID = localStorage.getItem("teacher_id");
let TEACHER_CLASSES = {}; // { className: [subject1, subject2] }
let EXAMS = [];

// ------------------------
// LOAD SESSIONS
// ------------------------
async function loadSessions() {
    try{
        const res = await fetch(`${EXAM_API}/session/list`);
        const data = await res.json();
        sessionSelect.innerHTML = data.sessions.map(s=>`<option>${s}</option>`).join("");
        if(data.sessions.length>0){
            sessionSelect.value = data.sessions[0];
            await loadTeacherClasses();
        }
    }catch(err){
        console.error("Failed to load sessions:",err);
    }
}
loadSessions();
sessionSelect.addEventListener("change", loadTeacherClasses);

// ------------------------
// LOAD TEACHER CLASSES & SUBJECTS
// ------------------------
async function loadTeacherClasses(){
    const session = sessionSelect.value;
    if(!session || !TEACHER_ID) return;

    try{
        const res = await fetch(`${EXAM_API}/timetable/get?session=${encodeURIComponent(session)}&teacher_id=${encodeURIComponent(TEACHER_ID)}`);
        const data = await res.json();
        TEACHER_CLASSES = {};
        if(data.success && Array.isArray(data.timetable)){
            const days = ["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
            data.timetable.forEach(row=>{
                const cls = row.class;
                if(!cls) return;
                if(!TEACHER_CLASSES[cls]) TEACHER_CLASSES[cls] = new Set();
                days.forEach(d=>{
                    if(row[d] && row[d].trim()!=="") TEACHER_CLASSES[cls].add(row[d].trim());
                });
            });
        }

        const classes = Object.keys(TEACHER_CLASSES).sort();
        classSelect.innerHTML = `<option value="">Select Class</option>` + classes.map(c=>`<option value="${c}">${c}</option>`).join("");
        if(classes.length>0) classSelect.value = classes[0];
        await loadExams();
        await loadSubjects();
    }catch(err){
        console.error("Error loading teacher classes:",err);
    }
}
classSelect.addEventListener("change", loadSubjects);

// ------------------------
// LOAD EXAMS (only internal marks = yes)
// ------------------------
async function loadExams(){
    try{
        const res = await fetch(`${EXAM_API}/exam/list-all`);
        const data = await res.json();
        const session = sessionSelect.value;
        EXAMS = (data.exams || []).filter(e=>{
            const v = e.internal_marks;
            const allowInternal =
                v === true || v === "yes" || v === "Yes" || v === "true" || v === 1;
            const sameSession = !session || e.session === session;
            return allowInternal && sameSession;
        });
        examSelect.innerHTML = EXAMS.length
            ? EXAMS.map(e=>`<option value="${e.exam_name}">${e.exam_name}</option>`).join("")
            : `<option value="">No internal exams</option>`;
    }catch(err){
        console.error("Error loading exams:", err);
        examSelect.innerHTML = `<option value="">Error loading exams</option>`;
    }
}

// ------------------------
// LOAD SUBJECTS (teacher-specific)
// ------------------------
async function loadSubjects(){
    const cls = classSelect.value;
    if(!cls) return;
    const subjects = Array.from(TEACHER_CLASSES[cls] || []);
    subjectSelect.innerHTML = subjects.map(s=>`<option>${s}</option>`).join("");
}

// ------------------------
// LOAD STUDENTS + INTERNAL MARKS
// ------------------------
async function loadStudents(){
    const session = sessionSelect.value;
    const cls = classSelect.value;
    const exam = examSelect.value;
    const sub = subjectSelect.value;
    if(!cls||!sub||!exam) return;

    try{
        const res = await fetch(`${STUDENT_API}/students?session=${session}`);
        const students = await res.json();
        const classStudents = students
            .filter(s => s.class_name === cls)
            .sort((a, b) => (parseInt(a.rollno)||0) - (parseInt(b.rollno)||0));

        await loadMaxMarks();
        let html = `<table><tr><th>Roll No</th><th>Name</th><th>Max Marks</th><th>Marks</th><th>Percent</th></tr>`;
        classStudents.forEach(s=>{
            const sid = s._id || s.id || s.student_id || "";
            html += `<tr>
                <td>${s.rollno}</td>
                <td>${s.student_name}</td>
                <td class="max-cell">${MAX_INTERNAL !== null ? MAX_INTERNAL : "-"}</td>
                <td><input type="number" data-student-id="${sid}" data-student-name="${s.student_name}" min="0"></td>
                <td class="percent-cell"></td>
            </tr>`;
        });
        html += `</table>`;
        document.getElementById("tableContainer").innerHTML = html;

        await loadExistingInternalMarks();
        applyMaxAndPercent();
    }catch(err){
        console.error("Error loading students:",err);
    }
}

// ------------------------
// LOAD MAX INTERNAL MARKS
// ------------------------
let MAX_INTERNAL = null;
async function loadMaxMarks(){
    const session = sessionSelect.value;
    const cls = classSelect.value;
    const sub = subjectSelect.value;
    if(!cls||!sub) return;

    try{
        const res = await fetch(`${EXAM_API}/internal-config/get?session=${encodeURIComponent(session)}&class_name=${encodeURIComponent(cls)}&subject=${encodeURIComponent(sub)}`);
        const data = await res.json();
        if(data.success && data.config && data.config.max_marks != null){
            MAX_INTERNAL = Number(data.config.max_marks);
        }else{
            MAX_INTERNAL = null;
        }
    }catch(err){
        console.error("Error loading max marks:",err);
        MAX_INTERNAL = null;
    }
}

// ------------------------
// APPLY MAX + PERCENT
// ------------------------
function applyMaxAndPercent(){
    const rows = document.querySelectorAll("#tableContainer table tr");
    rows.forEach((tr,i)=>{
        if(i===0) return;
        const input = tr.querySelector("input[data-student-id]");
        const maxCell = tr.querySelector(".max-cell");
        const percentCell = tr.querySelector(".percent-cell");
        if(maxCell) maxCell.textContent = (MAX_INTERNAL !== null ? MAX_INTERNAL : "-");
        if(input){
            if(MAX_INTERNAL !== null){
                input.max = MAX_INTERNAL;
            }else{
                input.removeAttribute("max");
            }
            const marks = Number(input.value);
            if(percentCell){
                const percent = (MAX_INTERNAL !== null && !isNaN(marks)) ? ((marks / MAX_INTERNAL) * 100).toFixed(2) : "";
                percentCell.textContent = percent ? `${percent}%` : "";
            }
            input.addEventListener("input", applyMaxAndPercent);
        }
    });
}

// ------------------------
// LOAD EXISTING INTERNAL MARKS
// ------------------------
async function loadExistingInternalMarks(){
    const session = sessionSelect.value;
    const cls = classSelect.value;
    const exam = examSelect.value;
    const sub = subjectSelect.value;
    if(!cls||!sub||!exam) return;

    try{
        const res = await fetch(`${EXAM_API}/internal-marks/list?session=${encodeURIComponent(session)}&class_name=${encodeURIComponent(cls)}&subject=${encodeURIComponent(sub)}&exam_name=${encodeURIComponent(exam)}`);
        const data = await res.json();
        if(!data.success) return;
        data.marks.forEach(m=>{
            const input = document.querySelector(`input[data-student-id='${m.student_id}']`);
            if(input) input.value = m.marks;
        });
        applyMaxAndPercent();
    }catch(err){ console.error(err); }
}

// ------------------------
// UPLOAD INTERNAL MARKS
// ------------------------
async function uploadInternalMarks(){
    const session = sessionSelect.value;
    const cls = classSelect.value;
    const exam = examSelect.value;
    const sub = subjectSelect.value;
    if(!cls||!sub||!exam) return alert("Select class, exam and subject!");

    const rows = document.querySelectorAll("input[data-student-id]");
    if(MAX_INTERNAL !== null){
        for(const r of rows){
            const val = Number(r.value || 0);
            if(val > MAX_INTERNAL){
                return alert(`Marks cannot be greater than max (${MAX_INTERNAL}) for student ${r.dataset.studentName}`);
            }
        }
    }
    const marksList = Array.from(rows).map(r=>({
        student_id: r.dataset.studentId,
        student_name: r.dataset.studentName,
        marks: r.value || 0
    }));

    try{
        const res = await fetch(`${EXAM_API}/internal-marks/save`,{
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body: JSON.stringify({ session, class_name: cls, subject: sub, exam_name: exam, teacher_id: TEACHER_ID, marks: marksList })
        });
        const data = await res.json().catch(()=>({}));
        if(!res.ok || data.success === false){
            const msg = data.message || `Upload failed (${res.status})`;
            alert(msg);
            return;
        }
        alert(data.message || "Internal marks uploaded!");
    }catch(err){
        console.error(err);
        alert("Error uploading internal marks");
    }
}

// ------------------------
// EXPORT CSV
// ------------------------
function exportCSV(){
    const table = document.querySelector("#tableContainer table");
    if(!table) return alert("No data to export!");
    let csv = [];
    const rows = table.querySelectorAll("tr");
    rows.forEach(tr=>{
        const row = [];
        tr.querySelectorAll("th,td").forEach(td=>{
            const input = td.querySelector("input");
            if(input) row.push(input.value); else row.push(td.textContent.trim());
        });
        csv.push(row.join(","));
    });
    const blob = new Blob([csv.join("\n")],{type:"text/csv"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `internal_marks_${Date.now()}.csv`;
    a.click();
    URL.revokeObjectURL(url);
}

// ------------------------
// HAMBURGER TOGGLE
// ------------------------
const hamburger = document.getElementById("hamburger");
const sidebar = document.getElementById("sidebar");
const content = document.getElementById("content");

hamburger.addEventListener("click", ()=>{
    sidebar.classList.toggle("show");
    content.classList.toggle("shifted");
});

content.addEventListener("click", ()=>{
    if(window.innerWidth <= 768 && sidebar.classList.contains("show")){
        sidebar.classList.remove("show");
        content.classList.remove("shifted");
    }
});

// hide sidebar if resizing desktop
window.addEventListener("resize", ()=>{
    if(window.innerWidth > 768){
        sidebar.classList.remove("show");
        content.classList.remove("shifted");
    }
});
</script>

</body>
</html>

