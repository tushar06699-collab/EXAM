<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Add Subjects â€“ School ERP</title>

<style>
body {
  margin: 0;
  font-family: Poppins, sans-serif;
  background: #f2f4f7;
  display: flex;
}

/* ---------------- SIDEBAR ---------------- */
.sidebar {
  width: 240px;
  background: #233465;
  color: white;
  height: 100vh;
  padding: 20px 0;
  position: fixed;
  left: 0;
  top: 0;
  overflow-y: auto;
  box-shadow: 2px 0 10px rgba(0,0,0,0.15);
}

.sidebar h2 {
  text-align: center;
  font-size: 22px;
  margin-bottom: 25px;
  font-weight: 600;
}

.sidebar a {
  display: block;
  padding: 12px 22px;
  font-size: 16px;
  color: white;
  text-decoration: none;
  transition: 0.2s;
}

.sidebar a:hover {
  background: rgba(255,255,255,0.15);
  padding-left: 30px;
}

.sidebar .active {
  background: rgba(255,255,255,0.25);
}

/* ---------------- CONTENT ---------------- */
.content {
  margin-left: 260px;
  padding: 25px;
  width: calc(100% - 260px);
}

header {
  background: #233465;
  color: white;
  padding: 1rem;
  text-align: center;
  font-size: 1.4rem;
  border-radius: 8px;
}

main {
  background: white;
  padding: 2rem;
  border-radius: 12px;
  margin-top: 1.5rem;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

/* ---------------- TABLE ---------------- */
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
}

th, td {
  border: 1px solid #ccc;
  padding: 8px;
}

input {
  width: 90%;
  padding: 6px;
}

button {
  padding: 6px 12px;
  background: #302c7d;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}
button:hover { background: #3730a3; }

</style>
</head>

<body>

<!-- ---------------- SIDEBAR ---------------- -->
<div class="sidebar">
    <h2>School ERP</h2>

    <a href="dashboard.html">Dashboard</a>
    <a href="subject_add_all.html" class="active">Add Subjects</a>
    <a href="teachers.html">Teacher Management</a>
    <a href="Timetable.html">Add Timetable</a>
    <a href="get_classes_timetable.html">View Class Timetable</a>
    <a href="get_teacher_timetable.html">View Teacher Timetable</a>
</div>

<!-- ---------------- CONTENT ---------------- -->
<div class="content">
<header>Add Subjects (All Classes)</header>

<main>

    <label>Session:</label>
    <select id="sessionSelect"></select>

    <table>
        <thead>
            <tr>
                <th>Class</th>
                <th>Subject 1</th>
                <th>Subject 2</th>
                <th>Subject 3</th>
                <th>Subject 4</th>
                <th>Subject 5</th>
                <th>Subject 6</th>
                <th>Subject 7</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="classSubjectTable"></tbody>
    </table>

</main>
</div>

<!-- ---------------- SCRIPT ---------------- -->
<script>
const EXAM_API = "https://exam-backend-ko0t.onrender.com";
const STUDENT_API = "https://students-backend-8mup.onrender.com";

const sessionSelect = document.getElementById("sessionSelect");
const classSubjectTable = document.getElementById("classSubjectTable");
let currentSession = localStorage.getItem("session") || "";

/* ---------- Load Sessions ---------- */
async function loadSessions() {
    const res = await fetch(`${EXAM_API}/session/list`);
    const data = await res.json();

    sessionSelect.innerHTML = data.sessions.map(s => `<option>${s}</option>`).join("");
    sessionSelect.value = currentSession || data.sessions[0];
    currentSession = sessionSelect.value;

    sessionSelect.onchange = () => {
        currentSession = sessionSelect.value;
        localStorage.setItem("session", currentSession);
        loadAllClasses();
    };

    loadAllClasses();
}

/* ---------- Load All Classes ---------- */
async function loadAllClasses() {

    classSubjectTable.innerHTML = `<tr><td colspan="9">Loading...</td></tr>`;

    const res = await fetch(`${STUDENT_API}/students`);
    const students = await res.json();

    let classList = [...new Set(students.map(s => s.class_name).filter(Boolean))];

    classList.sort((a,b)=>{
        let A = parseInt(a);
        let B = parseInt(b);
        return A - B;
    });

    classSubjectTable.innerHTML = "";
    classList.forEach(cls => createClassRow(cls));

}

/* ---------- Create Class Row ---------- */
async function createClassRow(className) {

    const row = document.createElement("tr");
    row.innerHTML = `
        <td>${className}</td>
        <td><input id="${className}-1"></td>
        <td><input id="${className}-2"></td>
        <td><input id="${className}-3"></td>
        <td><input id="${className}-4"></td>
        <td><input id="${className}-5"></td>
        <td><input id="${className}-6"></td>
        <td><input id="${className}-7"></td>
        <td><button onclick="saveSubjects('${className}')">Save</button></td>
    `;
    classSubjectTable.appendChild(row);

    loadSubjects(className);
}

/* ---------- Load Existing Subjects ---------- */
async function loadSubjects(className) {
    const res = await fetch(`${EXAM_API}/exam/subjects/get?session=${currentSession}&class_name=${className}`);
    const data = await res.json();

    const subjects = data.subjects || [];

    subjects.forEach((sub, i) => {
        const input = document.getElementById(`${className}-${i+1}`);
        if (input) input.value = sub;
    });
}

/* ---------- Save Subjects ---------- */
async function saveSubjects(className) {

    let subjects = [];
    for (let i = 1; i <= 7; i++) {
        let value = document.getElementById(`${className}-${i}`).value.trim();
        if (value) subjects.push(value);
    }

    if (subjects.length === 0) {
        alert("Enter at least one subject");
        return;
    }

    const res = await fetch(`${EXAM_API}/exam/subjects/add`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            session: currentSession,
            class_name: className,
            subjects
        })
    });

    const result = await res.json();
    alert(result.success ? "Subjects saved!" : result.message);
}

window.onload = loadSessions;
</script>

</body>
</html>
